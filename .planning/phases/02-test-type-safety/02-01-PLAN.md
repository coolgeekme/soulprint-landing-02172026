---
phase: 02-test-type-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/cross-lang/emotional-intelligence-sync.test.ts
  - __tests__/cross-lang/prompt-sync.test.ts
  - tests/integration/api/import/chunked-upload.test.ts
  - tests/integration/api/import/complete.test.ts
  - tests/integration/api/import/process-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Cross-language EI sync test compiles with strict TypeScript types (EmotionalState, relationship arc union)"
    - "Cross-language prompt sync test accepts PromptBuilderProfile type in helper function"
    - "Chunked upload test uses Uint8Array for Buffer→Blob conversion"
    - "Complete test uses non-null assertions for array access and type assertions for mock overrides"
    - "Process-server test removes zlib.default and uses type assertions for storage mocks"
    - "Running `npx tsc --noEmit` produces zero errors across all test files"
  artifacts:
    - path: "__tests__/cross-lang/emotional-intelligence-sync.test.ts"
      provides: "Proper types for buildRelationshipArcInstructions and buildAdaptiveToneInstructions"
      min_lines: 3
    - path: "__tests__/cross-lang/prompt-sync.test.ts"
      provides: "callPythonPromptBuilder accepts PromptBuilderProfile instead of Record<string, unknown>"
      contains: "profile: PromptBuilderProfile"
    - path: "tests/integration/api/import/chunked-upload.test.ts"
      provides: "Buffer→Uint8Array conversion, mock nullability fixes"
      contains: "new Uint8Array"
    - path: "tests/integration/api/import/complete.test.ts"
      provides: "Non-null assertions and `as any` for mock type overrides"
      contains: "mock.calls[0]!"
    - path: "tests/integration/api/import/process-server.test.ts"
      provides: "Removed zlib.default, storage mock type assertions"
      contains: "gzipSync: vi.fn"
  key_links:
    - from: "__tests__/cross-lang/emotional-intelligence-sync.test.ts"
      to: "@/lib/soulprint/emotional-intelligence"
      via: "Import actual EmotionalState type, use union types for relationship arc"
      pattern: "type { EmotionalState }"
    - from: "__tests__/cross-lang/prompt-sync.test.ts"
      to: "@/lib/soulprint/prompt-builder"
      via: "callPythonPromptBuilder parameter typed as PromptBuilderProfile"
      pattern: "profile: PromptBuilderProfile"
    - from: "tests/integration/api/import/*.test.ts"
      to: "Vitest mocks"
      via: "Type assertions `as any` for mock overrides, non-null assertions for array access"
      pattern: "as any|mock\\.calls\\[0\\]!"
---

<objective>
Fix all 21 TypeScript compilation errors in test files to enable strict mode type checking without runtime regressions.

Purpose: Currently, `tsconfig.json` EXCLUDES all test files (`__tests__`, `tests`, `**/*.test.ts`), hiding 21 type errors that would surface in CI or stricter environments. This plan fixes all errors by: (1) using actual imported types instead of overly broad inline types in cross-language sync tests, (2) converting Buffers to Uint8Array for Blob compatibility, (3) using pragmatic type assertions (`as any`) for Vitest mock overrides, and (4) adding non-null assertions for array access under `noUncheckedIndexedAccess`. All fixes are localized to test files — zero runtime code changes.

Output: All test files compile cleanly under `npx tsc --noEmit`, all tests continue to pass, enabling future inclusion of test files in TypeScript strict mode checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-test-type-safety/02-RESEARCH.md
@__tests__/cross-lang/emotional-intelligence-sync.test.ts
@__tests__/cross-lang/prompt-sync.test.ts
@tests/integration/api/import/chunked-upload.test.ts
@tests/integration/api/import/complete.test.ts
@tests/integration/api/import/process-server.test.ts
@lib/soulprint/emotional-intelligence.ts
@lib/soulprint/prompt-builder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Cross-Language EI Sync Test Types (2 errors)</name>
  <files>__tests__/cross-lang/emotional-intelligence-sync.test.ts</files>
  <action>
Fix type precision in cross-language emotional intelligence sync test by using actual imported types instead of overly broad inline declarations.

**Error 1 - buildRelationshipArcInstructions (line 16):**
Replace overly broad inline type:
```typescript
// BEFORE (line 16):
let buildRelationshipArcInstructions: (arc: { stage: string; messageCount: number }) => string;

// AFTER:
let buildRelationshipArcInstructions: (arc: { stage: 'early' | 'developing' | 'established'; messageCount: number }) => string;
```

**Error 2 - buildAdaptiveToneInstructions (line 17):**
Add EmotionalState type import and use it:
```typescript
// Add to imports (after line 12):
import type { EmotionalState } from '@/lib/soulprint/emotional-intelligence';

// BEFORE (line 17):
let buildAdaptiveToneInstructions: (state: { primary: string; confidence: number; cues: string[] }) => string;

// AFTER:
let buildAdaptiveToneInstructions: (state: EmotionalState) => string;
```

**Why this matters:** These tests verify cross-language sync between TypeScript and Python. Using `string` instead of exact union types defeats type checking and could mask mismatches where Python returns an unexpected value. The actual functions from `@/lib/soulprint/emotional-intelligence` have stricter types that must match Python's output.

**What NOT to change:**
- Do NOT modify the test logic (lines 50+)
- Do NOT add runtime validation (TypeScript types are compile-time only)
- Do NOT change the Python subprocess call logic
  </action>
  <verify>
Run `npx tsc --noEmit` and grep for errors in emotional-intelligence-sync.test.ts. Should show 0 errors (down from 2).
  </verify>
  <done>
Line 16 has union type `'early' | 'developing' | 'established'` for stage parameter, line 17 uses imported `EmotionalState` type, TypeScript compilation passes for this file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Cross-Language Prompt Sync Test Types (6 errors)</name>
  <files>__tests__/cross-lang/prompt-sync.test.ts</files>
  <action>
Fix type mismatch between callPythonPromptBuilder helper and actual PromptBuilderProfile type.

**Root cause:** The helper declares `profile: Record<string, unknown>` (line 73) but tests pass `TEST_PROFILE: PromptBuilderProfile` which has stricter types (`string | null`, optional fields). TypeScript correctly flags this as incompatible.

**Fix (line 73):**
```typescript
// BEFORE:
function callPythonPromptBuilder(
  version: string,
  params: {
    profile: Record<string, unknown>;  // <-- Too broad
    dailyMemory?: Array<{ fact: string; category: string }> | null;
    memoryContext?: string;
    aiName?: string;
    isOwner?: boolean;
    webSearchContext?: string;
    webSearchCitations?: string[];
  },
): string {

// AFTER:
function callPythonPromptBuilder(
  version: string,
  params: {
    profile: PromptBuilderProfile;  // <-- Use actual type
    dailyMemory?: Array<{ fact: string; category: string }> | null;
    memoryContext?: string;
    aiName?: string;
    isOwner?: boolean;
    webSearchContext?: string;
    webSearchCitations?: string[];
  },
): string {
```

**Why this matters:** The Python side expects the exact `PromptBuilderProfile` shape. Using `Record<string, unknown>` in the test helper loses type safety and could allow invalid test data. This change makes the test helper signature match what it actually receives (TEST_PROFILE is already typed as PromptBuilderProfile on line 28).

**Verify all 6 call sites resolve:** Lines 176, 198, 260, 285, 309, 339 all pass TEST_PROFILE to this helper. After changing the parameter type, all 6 errors should disappear.

**What NOT to change:**
- Do NOT modify TEST_PROFILE structure (line 28-58)
- Do NOT change the Python subprocess invocation logic
- Do NOT alter test assertions
  </action>
  <verify>
Run `npx tsc --noEmit` and grep for errors in prompt-sync.test.ts. Should show 0 errors (down from 6). Run `npm test __tests__/cross-lang/prompt-sync.test.ts` to verify tests still pass.
  </verify>
  <done>
Line 73 has `profile: PromptBuilderProfile` parameter type, all 6 call sites (176, 198, 260, 285, 309, 339) compile without type errors, tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Chunked Upload Test Types (3 errors)</name>
  <files>tests/integration/api/import/chunked-upload.test.ts</files>
  <action>
Fix Buffer/Blob type mismatch and mock nullability issues.

**Error 1 - Buffer to BlobPart conversion (line 16):**
```typescript
// BEFORE:
const blob = new Blob([buf]);  // buf is Buffer, Blob expects BlobPart

// AFTER:
const blob = new Blob([new Uint8Array(buf)]);
```
Why: In browser types, `BlobPart = string | Blob | ArrayBuffer | ArrayBufferView`. Node's Buffer is not directly assignable. Uint8Array is an ArrayBufferView and works correctly.

**Error 2 - Mock data nullability (line 180):**
```typescript
// BEFORE:
data: null,  // Type error: should be { path: string }

// AFTER:
data: { path: 'test-upload-path' },
```

**Error 3 - Mock error nullability (line 181):**
```typescript
// BEFORE:
error: { message: 'Upload failed' },  // Type error: error should be null when data is present

// AFTER:
error: null,
```

Context: These are in a mock setup where the base mock expects `{ data: { path: string }, error: null }` for success case. The override must match this signature.

**If the test intentionally tests error case:** Use type assertion instead:
```typescript
mockClient.storage.from = vi.fn(() => ({
  upload: vi.fn(() => ({ data: null, error: { message: 'Upload failed' } })),
})) as any;
```

**What NOT to change:**
- Do NOT modify test assertions or test behavior
- Do NOT change createMockAdminClient base mock (if it exists elsewhere)
  </action>
  <verify>
Run `npx tsc --noEmit` and grep for errors in chunked-upload.test.ts. Should show 0 errors (down from 3). Run `npm test tests/integration/api/import/chunked-upload.test.ts` to verify tests still pass.
  </verify>
  <done>
Line 16 uses `new Uint8Array(buf)` for Blob construction, lines 180-181 have correct mock nullability or type assertions, TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix Complete Test Mock Types (5 errors)</name>
  <files>tests/integration/api/import/complete.test.ts</files>
  <action>
Fix mock type mismatches using non-null assertions and type assertions.

**Error 1 - Line 52 (mock return type mismatch):**
Use type assertion for error-case mock:
```typescript
// BEFORE:
vi.mocked(createClient).mockReturnValueOnce({
  from: vi.fn(() => ({
    select: vi.fn(() => ({
      eq: vi.fn(() => ({
        single: vi.fn(() => ({ data: null, error: { message: 'string' } })),
      })),
    })),
  })),
});

// AFTER (add `as any` to override):
vi.mocked(createClient).mockReturnValueOnce({
  from: vi.fn(() => ({
    select: vi.fn(() => ({
      eq: vi.fn(() => ({
        single: vi.fn(() => ({ data: null, error: { message: 'string' } })),
      })),
    })),
  })),
} as any);
```

**Error 2 - Line 125, 181, 239 (similar mock type mismatches):**
Apply same pattern — add `as any` to mock override assignments where return type doesn't match base mock exactly.

**Error 3 - Line 173 (Object possibly undefined):**
```typescript
// BEFORE:
expect(vi.mocked(sendEmail).mock.calls[0][0]).toContain(...);

// AFTER (add non-null assertion):
expect(vi.mocked(sendEmail).mock.calls[0]![0]).toContain(...);
```

**Why this approach:** These are test mocks, not runtime code. Using `as any` for mock overrides is pragmatic — the tests verify behavior, not mock type precision. Non-null assertions for array access are safe when tests control the exact number of calls.

**Pattern to apply:** Find all `vi.mocked(...).mockReturnValueOnce(...)` where the return type differs from base mock → add `as any` after closing brace.

**What NOT to change:**
- Do NOT modify test logic or assertions
- Do NOT change base mock factory (createMockAdminClient if it exists)
- Do NOT add runtime null checks (non-null assertion `!` is compile-time only)
  </action>
  <verify>
Run `npx tsc --noEmit` and grep for errors in complete.test.ts. Should show 0 errors (down from 5). Run `npm test tests/integration/api/import/complete.test.ts` to verify tests still pass.
  </verify>
  <done>
Lines 52, 125, 181, 239 use `as any` for mock overrides, line 173 uses `mock.calls[0]!` non-null assertion, TypeScript compilation passes, all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 5: Fix Process-Server Test Mock Types (5 errors)</name>
  <files>tests/integration/api/import/process-server.test.ts</files>
  <action>
Fix zlib default export error and storage mock signature mismatches.

**Error 1 - Line 43 (zlib.default does not exist):**
```typescript
// BEFORE (lines 38-47):
vi.mock('zlib', async (importOriginal) => {
  const actual = await importOriginal<typeof import('zlib')>();
  return {
    ...actual,
    default: {  // <-- zlib has no default export
      ...actual.default,
      gzipSync: vi.fn((buffer) => Buffer.from('compressed-data')),
    },
    gzipSync: vi.fn((buffer) => Buffer.from('compressed-data')),
  };
});

// AFTER (remove entire default property):
vi.mock('zlib', async (importOriginal) => {
  const actual = await importOriginal<typeof import('zlib')>();
  return {
    ...actual,
    gzipSync: vi.fn((buffer) => Buffer.from('compressed-data')),
  };
});
```

**Why:** Node's `zlib` is a CommonJS module with named exports only, no default export.

**Errors 2-5 - Lines 194, 223, 282, 311 (storage mock signature mismatches):**
Base mock expects `from: vi.fn((bucket: string) => ({ download, upload, remove }))`, but test overrides omit bucket parameter and upload method.

Apply type assertion to each override:
```typescript
// BEFORE (line 194):
mockClient.storage.from = vi.fn(() => ({  // <-- Missing (bucket: string) param
  download: vi.fn(() => ({ data: mockBlob, error: null })),
  remove: vi.fn(() => ({ catch: vi.fn() })),
}));

// AFTER (add `as any`):
mockClient.storage.from = vi.fn(() => ({
  download: vi.fn(() => ({ data: mockBlob, error: null })),
  remove: vi.fn(() => ({ catch: vi.fn() })),
})) as any;
```

Apply same pattern to lines 223, 282, 311.

**Why this approach:** These tests don't use the bucket parameter or upload method in these specific scenarios, so exact type matching adds no test value. Type assertion is faster than refactoring all overrides to match base signature exactly.

**What NOT to change:**
- Do NOT modify createMockAdminClient base factory
- Do NOT alter test assertions or test behavior
- Do NOT add bucket parameter if test doesn't use it
  </action>
  <verify>
Run `npx tsc --noEmit` and grep for errors in process-server.test.ts. Should show 0 errors (down from 5). Run `npm test tests/integration/api/import/process-server.test.ts` to verify tests still pass.
  </verify>
  <done>
Lines 38-47 have zlib mock without default property, lines 194, 223, 282, 311 use `as any` for storage mock overrides, TypeScript compilation passes, all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 6: Verify All Test Type Errors Resolved</name>
  <files>None (verification only)</files>
  <action>
Run comprehensive verification to confirm all 21 TypeScript test type errors are resolved and no runtime regressions occurred.

**Step 1: Full TypeScript compilation check:**
```bash
npx tsc --noEmit
```
Expect: Zero errors (down from 21 errors before fixes).

**Step 2: Run all affected tests:**
```bash
# Cross-language sync tests
npx vitest run __tests__/cross-lang/emotional-intelligence-sync.test.ts
npx vitest run __tests__/cross-lang/prompt-sync.test.ts

# Integration tests
npx vitest run tests/integration/api/import/chunked-upload.test.ts
npx vitest run tests/integration/api/import/complete.test.ts
npx vitest run tests/integration/api/import/process-server.test.ts
```
Expect: All tests pass (same pass count as before fixes).

**Step 3: Verify specific fixes with grep:**
```bash
# Verify EI sync uses EmotionalState type
grep -n "type { EmotionalState }" __tests__/cross-lang/emotional-intelligence-sync.test.ts

# Verify prompt sync uses PromptBuilderProfile
grep -n "profile: PromptBuilderProfile" __tests__/cross-lang/prompt-sync.test.ts

# Verify chunked-upload uses Uint8Array
grep -n "new Uint8Array" tests/integration/api/import/chunked-upload.test.ts

# Verify complete test has non-null assertions
grep -n "mock.calls\[0\]!" tests/integration/api/import/complete.test.ts

# Verify process-server removed zlib.default
grep -n "default:" tests/integration/api/import/process-server.test.ts | grep -c "zlib" || echo "0"
```
Expect: All grep patterns found (or 0 count for removed zlib.default).

**What success looks like:**
- `npx tsc --noEmit` produces zero errors
- All 5 test files pass without runtime failures
- Grep confirms all fixes are in place
- No changes to runtime code (only test files modified)
  </action>
  <verify>
All verification commands pass: tsc shows 0 errors, all 5 test files pass, grep patterns confirm fixes.
  </verify>
  <done>
TypeScript compilation produces zero errors across all test files, all tests pass with same results as before fixes, grep confirms type imports, Uint8Array usage, non-null assertions, and removed zlib.default.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors (down from 21)
2. All cross-language sync tests pass (EI sync, prompt sync)
3. All integration tests pass (chunked-upload, complete, process-server)
4. Grep confirms EmotionalState import in EI sync test
5. Grep confirms PromptBuilderProfile usage in prompt sync test
6. Grep confirms Uint8Array conversion in chunked-upload test
7. Grep confirms non-null assertions and `as any` in complete test
8. Grep confirms zlib.default removed from process-server test
9. No modifications to runtime code (all changes in test files only)
</verification>

<success_criteria>
- Cross-language EI sync test uses actual EmotionalState type and union types for relationship arc
- Cross-language prompt sync test callPythonPromptBuilder accepts PromptBuilderProfile
- Chunked upload test uses Uint8Array for Buffer→Blob conversion
- Complete test uses non-null assertions for array access and type assertions for mock overrides
- Process-server test removes zlib.default and uses type assertions for storage mocks
- Running `npx tsc --noEmit` produces zero errors across all test files
- All tests still pass (no runtime regressions from type fixes)
- Zero changes to runtime code (fixes isolated to test files)
</success_criteria>

<output>
After completion, create `.planning/phases/02-test-type-safety/02-01-SUMMARY.md`
</output>
