---
phase: 01-schema-quick-pass-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/bedrock.ts
  - lib/soulprint/types.ts
  - lib/soulprint/sample.ts
  - supabase/migrations/20260206_add_tools_md.sql
autonomous: true

must_haves:
  truths:
    - "CLAUDE_MODELS object includes HAIKU_45 with correct Bedrock model ID"
    - "TypeScript interfaces exist for all 5 quick pass sections (soul, identity, user, agents, tools)"
    - "Conversation sampling selects richest conversations by message count, user message length, balance, and recency"
    - "Sampling filters out conversations with fewer than 4 messages"
    - "Sampling caps at 50 conversations and respects a token budget"
    - "tools_md migration SQL file exists and is correct"
  artifacts:
    - path: "lib/bedrock.ts"
      provides: "HAIKU_45 model constant"
      contains: "us.anthropic.claude-haiku-4-5-20251001-v1:0"
    - path: "lib/soulprint/types.ts"
      provides: "QuickPassResult interface, section sub-interfaces"
      exports: ["QuickPassResult", "SoulSection", "IdentitySection", "UserSection", "AgentsSection", "ToolsSection"]
    - path: "lib/soulprint/sample.ts"
      provides: "Conversation sampling and formatting"
      exports: ["sampleConversations", "formatConversationsForPrompt"]
    - path: "supabase/migrations/20260206_add_tools_md.sql"
      provides: "SQL migration for tools_md column"
      contains: "ALTER TABLE"
  key_links:
    - from: "lib/soulprint/types.ts"
      to: "lib/soulprint/sample.ts"
      via: "sample.ts imports ParsedConversation-compatible types"
      pattern: "ParsedConversation"
    - from: "lib/bedrock.ts"
      to: "CLAUDE_MODELS"
      via: "HAIKU_45 key added to existing const object"
      pattern: "HAIKU_45"
---

<objective>
Create the foundation layer for the quick pass pipeline: add Haiku 4.5 model constant, define TypeScript interfaces for all 5 structured sections, implement conversation sampling logic, and create the tools_md migration SQL.

Purpose: Everything in Plan 02 (generation + wiring) depends on having types, the model constant, and sampling logic ready. This is the shared foundation.
Output: 4 files -- updated lib/bedrock.ts, new lib/soulprint/types.ts, new lib/soulprint/sample.ts, new migration SQL file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-quick-pass-pipeline/01-RESEARCH.md

@lib/bedrock.ts
@app/api/import/process-server/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Haiku 4.5 model constant + TypeScript interfaces + migration SQL</name>
  <files>lib/bedrock.ts, lib/soulprint/types.ts, supabase/migrations/20260206_add_tools_md.sql</files>
  <action>
1. In `lib/bedrock.ts`, add `HAIKU_45` to the `CLAUDE_MODELS` object:
   ```typescript
   export const CLAUDE_MODELS = {
     SONNET: 'anthropic.claude-3-5-sonnet-20241022-v2:0',
     HAIKU: 'anthropic.claude-3-5-haiku-20241022-v1:0',
     HAIKU_45: 'us.anthropic.claude-haiku-4-5-20251001-v1:0',
     OPUS: 'anthropic.claude-3-opus-20240229-v1:0',
   } as const;
   ```
   The `us.` prefix is the cross-region inference profile ID required for Haiku 4.5 on Bedrock.

2. Create `lib/soulprint/types.ts` with interfaces matching the JSON structure Haiku 4.5 will return:

   - `SoulSection` -- communication_style (string), personality_traits (string[]), tone_preferences (string), boundaries (string), humor_style (string), formality_level (string), emotional_patterns (string)
   - `IdentitySection` -- ai_name (string), archetype (string), vibe (string), emoji_style (string), signature_greeting (string)
   - `UserSection` -- name (string), location (string), occupation (string), relationships (string[]), interests (string[]), life_context (string), preferred_address (string)
   - `AgentsSection` -- response_style (string), behavioral_rules (string[]), context_adaptation (string), memory_directives (string), do_not (string[])
   - `ToolsSection` -- likely_usage (string[]), capabilities_emphasis (string[]), output_preferences (string), depth_preference (string)
   - `QuickPassResult` -- soul (SoulSection), identity (IdentitySection), user (UserSection), agents (AgentsSection), tools (ToolsSection)

   All fields should be required in the interfaces. The quick pass prompt will instruct Haiku to say "not enough data" for missing fields rather than omitting them.

   Also export a Zod schema `quickPassResultSchema` that validates the QuickPassResult shape. Use `z.object()` with `z.string()` and `z.array(z.string())` fields. Make all fields permissive (use `.default('')` or `.default([])`) so partial LLM responses don't crash validation -- the data quality matters more than strict shape enforcement.

3. Create `supabase/migrations/20260206_add_tools_md.sql`:
   ```sql
   -- Add tools_md column (the only missing structured section column)
   -- Other columns (soul_md, identity_md, agents_md, user_md) were added in 20260201_soulprint_files.sql
   ALTER TABLE public.user_profiles ADD COLUMN IF NOT EXISTS tools_md TEXT;
   COMMENT ON COLUMN public.user_profiles.tools_md IS 'TOOLS section - AI capabilities, usage patterns, output preferences';
   ```
   Note: This SQL must be run manually in Supabase SQL Editor (per project constraint -- no direct DB migrations from code). The file serves as documentation and source of truth.
  </action>
  <verify>
  - `npx tsc --noEmit` passes (type check)
  - `lib/bedrock.ts` contains `HAIKU_45` key in CLAUDE_MODELS
  - `lib/soulprint/types.ts` exports QuickPassResult, all 5 section interfaces, and quickPassResultSchema
  - Migration SQL file exists at expected path
  </verify>
  <done>
  CLAUDE_MODELS.HAIKU_45 resolves to 'us.anthropic.claude-haiku-4-5-20251001-v1:0'. All 5 section interfaces are exported. QuickPassResult Zod schema validates a complete 5-section JSON object. Migration SQL is ready for manual execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement conversation sampling logic</name>
  <files>lib/soulprint/sample.ts</files>
  <action>
Create `lib/soulprint/sample.ts` that exports two functions:

1. `sampleConversations(conversations: ParsedConversation[], targetTokens?: number): ParsedConversation[]`

   Import the `ParsedConversation` and `ConversationMessage` interfaces. Since these are defined locally in `process-server/route.ts`, re-define compatible interfaces in `lib/soulprint/types.ts` (or import from there). The types are simple: `{ id: string; title: string; messages: { role: string; content: string }[]; createdAt: string }`.

   Scoring algorithm (per research recommendations):
   - Filter out conversations with fewer than 4 messages
   - For each remaining conversation, compute score:
     - `conv.messages.length * 10` (prefer many messages)
     - `+ userMessages.reduce((sum, m) => sum + Math.min(m.content.length, 500), 0)` (prefer substantial user messages, capped at 500 chars each)
     - `+ Math.min(userMessages.length, assistantMessages.length) * 20` (prefer balanced conversations)
     - `+ (new Date(conv.createdAt).getTime() / 1e12)` (slight recency bonus)
   - Sort by score descending
   - Take conversations until cumulative character count exceeds `targetTokens * 4` (approx 4 chars/token)
   - If fewer than 5 conversations selected, force-include up to 5 even if over budget
   - Hard cap at 50 conversations
   - Default targetTokens: 50000

2. `formatConversationsForPrompt(conversations: ParsedConversation[]): string`

   Format sampled conversations as human-readable text blocks for the LLM prompt:
   ```
   === Conversation: "Title Here" (YYYY-MM-DD) ===
   User: message content
   Assistant: response content
   User: follow-up
   ...
   ```
   Truncate individual messages longer than 2000 characters (append "... [truncated]").
   Separate conversations with a blank line.

Use `createLogger('Soulprint:Sample')` from `@/lib/logger` for logging (how many conversations scored, how many selected, total chars).
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - `lib/soulprint/sample.ts` exports `sampleConversations` and `formatConversationsForPrompt`
  - The sampling function handles edge cases: empty array input, all conversations under 4 messages, single conversation
  </verify>
  <done>
  `sampleConversations` takes a ParsedConversation array and returns the richest subset within token budget. `formatConversationsForPrompt` converts the subset to a readable text block. Both functions handle edge cases gracefully.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run lint` passes
- All 3 new files exist: `lib/soulprint/types.ts`, `lib/soulprint/sample.ts`, `supabase/migrations/20260206_add_tools_md.sql`
- `lib/bedrock.ts` has HAIKU_45 in CLAUDE_MODELS
- No existing tests broken: `npm test` passes
</verification>

<success_criteria>
- HAIKU_45 model ID is available for use by Plan 02
- TypeScript interfaces and Zod schema are ready for quick pass response validation
- Conversation sampling selects top conversations by richness within token budget
- Migration SQL documents the only schema change needed
- All existing code continues to compile and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-quick-pass-pipeline/01-01-SUMMARY.md`
</output>
