---
phase: 07-type-safety-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/import/process-server/route.ts
  - app/api/import/queue-processing/route.ts
  - app/api/import/complete/route.ts
  - app/api/import/mem0/route.ts
  - app/import/page.tsx
  - lib/chunked-upload.ts
  - lib/bedrock.ts
  - lib/api/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Import flow code has zero `any` types (grep confirms none in import-related files)"
    - "External API responses from Bedrock and RLM are validated with Zod at boundaries"
    - "TypeScript build succeeds with no type errors"
    - "All 90 Vitest tests still pass after changes"
  artifacts:
    - path: "app/api/import/process-server/route.ts"
      provides: "Server-side import processing with typed conversations"
      contains: "ChatGPTRawConversationSchema"
    - path: "lib/api/schemas.ts"
      provides: "Zod schemas for ChatGPT export format and external API responses"
      contains: "BedrockEmbedResponseSchema"
    - path: "lib/bedrock.ts"
      provides: "Bedrock client with validated responses"
      contains: "safeParse"
  key_links:
    - from: "app/api/import/process-server/route.ts"
      to: "lib/api/schemas.ts"
      via: "import ChatGPT conversation schemas"
      pattern: "ChatGPTRawConversation"
    - from: "lib/bedrock.ts"
      to: "lib/api/schemas.ts"
      via: "import Bedrock response schemas"
      pattern: "BedrockEmbedResponseSchema"
---

<objective>
Replace all `any` types in the import flow with proper TypeScript interfaces and add Zod runtime validation for external API responses at boundaries.

Purpose: Eliminate type-safety gaps in the import pipeline where untyped data from ChatGPT exports, Bedrock, and RLM can cause silent runtime failures.

Output: Zero `any` types in import-related files, Zod schemas validating external data at boundaries, all existing tests passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-type-safety-refinement/07-RESEARCH.md
@lib/api/schemas.ts
@lib/mem0/chatgpt-parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod schemas for ChatGPT export format and external API responses</name>
  <files>lib/api/schemas.ts, lib/bedrock.ts</files>
  <action>
Add new Zod schemas to `lib/api/schemas.ts` for external data validation:

1. **ChatGPT Raw Conversation Schema** (for validating parsed JSON from user uploads):
```typescript
// Minimal validation - just enough to confirm structure, not every field
export const chatGPTRawConversationSchema = z.object({
  id: z.string().optional(),
  conversation_id: z.string().optional(),
  title: z.string().optional(),
  create_time: z.number().optional(),
  update_time: z.number().optional(),
  mapping: z.record(z.unknown()).optional(),
});

export const chatGPTExportSchema = z.array(chatGPTRawConversationSchema);

export type ChatGPTRawConversation = z.infer<typeof chatGPTRawConversationSchema>;
```

2. **Bedrock Embed Response Schema** (for validating Titan embedding response):
```typescript
export const bedrockEmbedResponseSchema = z.object({
  embedding: z.array(z.number()),
  inputTextTokenCount: z.number().optional(),
});
```

3. **RLM Process Response Schema** (for validating /process-full response):
```typescript
export const rlmProcessResponseSchema = z.object({
  status: z.string().optional(),
  message: z.string().optional(),
});
```

4. **Chunked Upload Result Schema** (for validating response.json() in chunked-upload.ts):
```typescript
export const chunkedUploadResultSchema = z.object({
  complete: z.boolean().optional(),
  path: z.string().optional(),
});
```

Then update `lib/bedrock.ts`:
- Line 191: Change `const result = JSON.parse(...)` to use `unknown` type and validate with `bedrockEmbedResponseSchema.safeParse()`. On validation failure, log the error and throw descriptive error.
- Import `bedrockEmbedResponseSchema` from `@/lib/api/schemas`.

Also update `bedrockChatJSON` function (line 119): The return type uses `T = unknown` which is already correct, but the `JSON.parse(jsonStr) as T` cast bypasses safety. This is acceptable since the function is generic and callers provide the type -- add a comment noting this is a deliberate cast for generic usage.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm test` -- all Vitest tests pass.
Run `grep -rn ": any\|as any" lib/bedrock.ts lib/api/schemas.ts` -- zero matches.
  </verify>
  <done>
Zod schemas exist for ChatGPT export, Bedrock embed response, RLM process response, and chunked upload result. Bedrock embed function validates response at boundary with safeParse. No `any` types in modified files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all `any` types in import flow source files</name>
  <files>app/api/import/process-server/route.ts, app/api/import/queue-processing/route.ts, app/api/import/complete/route.ts, app/api/import/mem0/route.ts, app/import/page.tsx, lib/chunked-upload.ts</files>
  <action>
Fix each `any` occurrence in the import flow:

**app/api/import/process-server/route.ts:**
- Line 121: `let rawConversations: any[]` -> `let rawConversations: unknown[]`. After JSON.parse, validate with `chatGPTExportSchema.safeParse()`. On failure, throw user-friendly error about invalid format.
- Line 163: `rawConversations.some((conv: any) =>` -> Remove `: any` annotation. Use a type guard or inline check since rawConversations is now `ChatGPTRawConversation[]` after validation.
- Line 211: `rawConversations.map((conv: any) => {` -> `rawConversations.map((conv) => {` (type inferred from validated array).
- Line 216: `Object.values(conv.mapping) as any[]` -> Type as `unknown[]` or create a `ChatGPTMappingNode` interface matching the structure used (`node?.message?.content?.parts?.[0]`). Since we already access with optional chaining, `unknown[]` works if we add appropriate type guards.
- Line 339: `catch (e: any)` -> `catch (e: unknown)`. Then use `if (e instanceof Error && e.name === 'AbortError')` and `String(e)` for the error log (the existing code at line 342 already checks `e.name` so use type guard).

**app/api/import/queue-processing/route.ts:**
- Line 185: `catch (fetchError: any)` -> `catch (fetchError: unknown)`. The existing code at line 186 already checks `fetchError instanceof Error` which handles narrowing. After the instanceof check, access `.name` safely.

**app/api/import/complete/route.ts:**
- Line 196: `subscription: any` -> `subscription: unknown`. This function `sendPushNotification` is currently dead code (commented out at call site). Type the parameter as `unknown` and add a type guard or use `as PushSubscription` type with a proper interface. Since it's dead code, `unknown` is sufficient.

**app/api/import/mem0/route.ts:**
- Line 81: `parseChatGPTExport(conversations as any)` -> Remove `as any`. The `parseChatGPTExport` function accepts `string | ChatGPTConversation[]`. Since `conversations` is `unknown[]`, validate first with `chatGPTExportSchema.safeParse(conversations)` and pass validated data.

**app/import/page.tsx:**
- Line 28: `data?: any` in `safeJsonParse` return type -> `data?: unknown`. This is correct since JSON.parse returns unknown data. Callers already access properties with optional chaining or checks.
- Line 64: `chunks: any[]` -> `chunks: unknown[]`. The function just calls `store.add(chunk)` on each -- IDBObjectStore.add accepts `any`, but we can type as `unknown` since we don't inspect the data.
- Line 75: `conversations: any[]` -> `conversations: unknown[]`. Same reasoning.

**lib/chunked-upload.ts:**
- Line 110: `data?: any` in `uploadWithProgress` return type -> `data?: unknown`. Callers don't use the `data` field (they only check `success`/`error`).

Import `chatGPTExportSchema`, `ChatGPTRawConversation` from `@/lib/api/schemas` where needed.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm test` -- all Vitest tests pass.
Run `grep -rn ": any\|as any\|any\[\]" app/api/import/ app/import/page.tsx lib/chunked-upload.ts` -- zero matches (excluding node_modules, test files, and comments).
  </verify>
  <done>
All import flow files have zero `any` types. ChatGPT export data validated with Zod at parse boundary. Error catch blocks use `unknown`. Return types use `unknown` instead of `any`. TypeScript build succeeds. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0 with no type errors
2. `npm test` -- all Vitest tests pass (90+ tests)
3. `grep -rn ": any\b\|: any;\|: any\[\|as any\|<any>" app/api/import/ app/import/page.tsx lib/chunked-upload.ts lib/bedrock.ts` returns zero results (excluding test files and eslint-disable comments)
4. `grep -rn "safeParse" lib/bedrock.ts` confirms Bedrock response validation exists
</verification>

<success_criteria>
- Zero `any` types in import flow files (process-server, queue-processing, complete, mem0 routes, import page, chunked-upload, bedrock client)
- Zod schemas validate ChatGPT export format at parse boundary in process-server
- Zod schema validates Bedrock embedding response in bedrock.ts
- TypeScript build succeeds with strict mode
- All 90+ Vitest tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-type-safety-refinement/07-01-SUMMARY.md`
</output>
