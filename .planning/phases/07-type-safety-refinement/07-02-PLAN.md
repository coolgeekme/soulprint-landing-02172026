---
phase: 07-type-safety-refinement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/chat/page.tsx
  - lib/mem0/client.ts
  - app/api/gamification/xp/route.ts
  - app/api/voice/upload/route.ts
  - lib/api/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Chat flow code has zero `any` types (grep confirms none in chat-related files)"
    - "Mem0 client validates API responses with Zod at boundaries"
    - "TypeScript build succeeds with no type errors"
    - "All 90 Vitest tests still pass after changes"
  artifacts:
    - path: "lib/mem0/client.ts"
      provides: "Mem0 client with Zod-validated responses"
      contains: "safeParse"
    - path: "app/api/gamification/xp/route.ts"
      provides: "XP route with typed Supabase client parameter"
      contains: "SupabaseClient"
    - path: "lib/api/schemas.ts"
      provides: "Zod schemas for Mem0 and Cloudinary responses"
      contains: "mem0SearchResponseSchema"
  key_links:
    - from: "lib/mem0/client.ts"
      to: "lib/api/schemas.ts"
      via: "import Mem0 response schemas"
      pattern: "mem0.*Schema"
---

<objective>
Replace all `any` types in the chat flow, gamification, and voice upload routes with proper TypeScript interfaces, and add Zod runtime validation for Mem0 API responses at boundaries.

Purpose: Eliminate type-safety gaps in chat-adjacent code where unvalidated external responses from Mem0 and Cloudinary can cause silent runtime failures.

Output: Zero `any` types in chat flow files, Zod schemas validating Mem0 responses, all existing tests passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-type-safety-refinement/07-RESEARCH.md
@lib/api/schemas.ts
@lib/mem0/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod schemas for Mem0 and Cloudinary responses, type the Mem0 client</name>
  <files>lib/api/schemas.ts, lib/mem0/client.ts</files>
  <action>
**lib/api/schemas.ts** -- Add response validation schemas:

1. **Mem0 Add Memory Response Schema:**
```typescript
export const mem0MemorySchema = z.object({
  id: z.string(),
  memory: z.string(),
  hash: z.string().optional(),
  metadata: z.record(z.unknown()).optional(),
  created_at: z.string().optional(),
  updated_at: z.string().optional(),
});

export const mem0AddResponseSchema = z.object({
  results: z.array(mem0MemorySchema),
  relations: z.array(z.unknown()).optional(),
});
```

2. **Mem0 Search Response Schema:**
```typescript
export const mem0SearchResultSchema = z.object({
  id: z.string(),
  memory: z.string(),
  score: z.number().optional(),
  metadata: z.record(z.unknown()).optional(),
});

export const mem0SearchResponseSchema = z.object({
  results: z.array(mem0SearchResultSchema),
});
```

3. **Mem0 Get All Response Schema:**
```typescript
export const mem0GetAllResponseSchema = z.object({
  results: z.array(mem0MemorySchema),
});
```

4. **Mem0 Delete Response Schema:**
```typescript
export const mem0DeleteResponseSchema = z.object({
  message: z.string(),
});
```

5. **Cloudinary Upload Result Schema** (for voice upload):
```typescript
export const cloudinaryUploadResultSchema = z.object({
  secure_url: z.string(),
  public_id: z.string(),
  duration: z.number().optional(),
  bytes: z.number(),
});
```

**lib/mem0/client.ts** -- Add Zod validation at response boundaries:

For each method that calls `response.json()`:
- `add()` (line 108): Change `return response.json()` to validate with `mem0AddResponseSchema.safeParse()`. On failure, log error and throw.
- `search()` (line 140): Validate with `mem0SearchResponseSchema.safeParse()`. On failure, log and throw.
- `getAll()` (line 158): Validate with `mem0GetAllResponseSchema.safeParse()`. On failure, log and throw.
- `deleteAll()` (line 178): Validate with `mem0DeleteResponseSchema.safeParse()`. On failure, log and throw.
- `get()` (line 193): Validate with `mem0MemorySchema.safeParse()`. On failure, log and throw.
- `delete()` (line 210): Validate with `mem0DeleteResponseSchema.safeParse()`. On failure, log and throw.

Pattern for each:
```typescript
const raw: unknown = await response.json();
const parsed = mem0AddResponseSchema.safeParse(raw);
if (!parsed.success) {
  console.error('[Mem0] Invalid add response:', parsed.error.issues);
  throw new Error('Invalid response from Mem0 API');
}
return parsed.data;
```

Import schemas from `@/lib/api/schemas`.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm test` -- all Vitest tests pass.
Run `grep -rn ": any\|as any" lib/mem0/client.ts` -- zero matches.
  </verify>
  <done>
Mem0 client validates all API responses with Zod at boundaries. Response schemas exist for add, search, getAll, get, delete, and deleteAll operations. No `any` types in Mem0 client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace `any` types in chat, gamification, and voice routes</name>
  <files>app/chat/page.tsx, app/api/gamification/xp/route.ts, app/api/voice/upload/route.ts</files>
  <action>
Fix each remaining `any` occurrence:

**app/api/gamification/xp/route.ts:**
- Line 165: `async function checkAchievements(supabase: any, userId: string, stats: Record<string, unknown>)` -- Replace `supabase: any` with proper Supabase client type. Import `SupabaseClient` from `@supabase/supabase-js`:
  ```typescript
  import { SupabaseClient } from '@supabase/supabase-js';
  // ...
  async function checkAchievements(supabase: SupabaseClient, userId: string, stats: Record<string, unknown>)
  ```
- Also remove the `// eslint-disable-next-line @typescript-eslint/no-explicit-any` comment on line 164 (no longer needed).

**app/api/voice/upload/route.ts:**
- Line 98: `else resolve(result as any)` -- The Cloudinary upload_stream callback returns `UploadApiResponse | undefined`. Replace `as any` with proper typing. Use the `cloudinaryUploadResultSchema` from schemas to validate at boundary:
  ```typescript
  import { cloudinaryUploadResultSchema } from '@/lib/api/schemas';
  // ...
  (error, result) => {
    if (error) reject(error);
    else {
      const parsed = cloudinaryUploadResultSchema.safeParse(result);
      if (!parsed.success) {
        reject(new Error('Invalid Cloudinary upload response'));
        return;
      }
      resolve(parsed.data);
    }
  }
  ```
  Update the Promise generic type to match the schema output: `Promise<z.infer<typeof cloudinaryUploadResultSchema>>` or use the explicit object type already defined in the Promise generic (lines 82-87). The existing explicit type `{ secure_url: string; public_id: string; duration?: number; bytes: number }` matches the schema, so keep it and just validate instead of casting.

**app/chat/page.tsx:**
- This file has NO explicit `any` types (confirmed by grep). No changes needed here. The `response.json()` calls return typed data through proper fetch patterns. The existing Message type is well-defined.

**Test files** -- The test files contain `as any` for mock objects (e.g., `mockClient as any`). These are acceptable in test files since they're mocking Supabase clients with partial implementations. Do NOT change test file `any` types -- they are standard practice for mocking and are not part of the TYPE-01 requirement (which specifies "import and chat code").
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm test` -- all Vitest tests pass.
Run `grep -rn ": any\|as any" app/api/gamification/xp/route.ts app/api/voice/upload/route.ts app/chat/page.tsx` -- zero matches (excluding eslint-disable comments).
  </verify>
  <done>
Gamification XP route uses typed SupabaseClient instead of `any`. Voice upload validates Cloudinary response with Zod instead of `as any` cast. Chat page confirmed to have no `any` types. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0 with no type errors
2. `npm test` -- all Vitest tests pass (90+ tests)
3. `grep -rn ": any\b\|: any;\|: any\[\|as any\|<any>" app/chat/page.tsx lib/mem0/client.ts app/api/gamification/xp/route.ts app/api/voice/upload/route.ts` returns zero results (excluding test files)
4. `grep -rn "safeParse" lib/mem0/client.ts` confirms all 6 Mem0 methods validate responses
</verification>

<success_criteria>
- Zero `any` types in chat flow files (chat page, Mem0 client, gamification XP, voice upload)
- Zod schemas validate all Mem0 API responses at boundaries (add, search, getAll, get, delete, deleteAll)
- Cloudinary upload response validated with Zod instead of `as any` cast
- TypeScript build succeeds with strict mode
- All 90+ Vitest tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-type-safety-refinement/07-02-SUMMARY.md`
</output>
