---
phase: 03-web-search-validation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/chat/message-content.tsx
  - app/api/chat/route.ts
  - components/chat/telegram-chat-v2.tsx
autonomous: true

must_haves:
  truths:
    - "Assistant messages with web search citations display domain name indicators in the UI"
    - "Citations are clickable links that open in new tabs"
    - "Users see clean domain names (e.g., 'nytimes.com') not full URLs"
    - "Citations appear consistently with every web search response"
  artifacts:
    - path: "components/chat/message-content.tsx"
      provides: "MessageContent component renders citation footer with domain indicators"
      min_lines: 20
      contains: "CitationMetadata"
    - path: "app/api/chat/route.ts"
      provides: "Include citation metadata in SSE stream for frontend consumption"
      contains: "formatCitationsForDisplay"
  key_links:
    - from: "app/api/chat/route.ts"
      to: "SSE stream"
      via: "Send citation metadata event with type:'citations' and CitationMetadata array"
      pattern: "type.*citations.*CitationMetadata"
    - from: "components/chat/message-content.tsx"
      to: "props.citations"
      via: "Render citation footer if citations exist, show domain badges"
      pattern: "citations.*map.*domain"
---

<objective>
Display validated web search citations in the chat UI with clean domain name indicators, completing the citation validation pipeline from backend to user-facing display.

Purpose: Backend validation (Plan 1) filters out invalid citations, but users still don't SEE the sources. This plan adds frontend display of validated citations below assistant messages, showing clickable domain badges (e.g., "nytimes.com", "techcrunch.com") for transparency and verifiability.

Output: Chat messages with web search results display citation source indicators below the response text, with clean domain names and clickable links.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-web-search-validation/03-RESEARCH.md
@.planning/phases/03-web-search-validation/03-01-SUMMARY.md
@components/chat/message-content.tsx
@app/api/chat/route.ts
@lib/search/citation-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Citation Metadata to SSE Stream</name>
  <files>app/api/chat/route.ts</files>
  <action>
Update the chat API route to send citation metadata to the frontend via Server-Sent Events.

**Find the SSE streaming section (around line 450-550, after LLM response generation):**

Look for the section where we're constructing the ReadableStream and streaming response chunks. This is where we build the stream that sends data to the frontend.

**Add citation metadata event BEFORE the [DONE] marker:**

After the main content streaming completes but before sending `data: [DONE]\n\n`, add:

```typescript
// WSRV-03: Send citation metadata to frontend
if (webSearchCitations.length > 0) {
  const citationMeta = formatCitationsForDisplay(webSearchCitations);
  const citationEvent = `data: ${JSON.stringify({
    type: 'citations',
    data: citationMeta
  })}\n\n`;
  controller.enqueue(new TextEncoder().encode(citationEvent));
}
```

**Location context:**
- This goes AFTER all content chunks have been streamed
- This goes BEFORE the `data: [DONE]\n\n` marker
- This is inside the streaming transform function where we have access to `controller.enqueue`

**What this does:**
- Formats validated citations using `formatCitationsForDisplay()` from Plan 1
- Sends as SSE event with `type: 'citations'` so frontend can distinguish from content
- Includes full CitationMetadata array (url, domain, title)
- Only sends if citations exist (webSearchCitations.length > 0)

**What NOT to change:**
- Do NOT modify the main content streaming logic
- Do NOT change how messages are saved to database
- Do NOT add citations to the message content string itself
- Do NOT block response streaming on citation formatting
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Grep for citation SSE event: `grep -B 2 -A 4 "type.*citations" app/api/chat/route.ts` — should find the SSE event construction with formatCitationsForDisplay call.
  </verify>
  <done>
Chat API route sends citation metadata via SSE with type:'citations' after content streaming completes. Uses formatCitationsForDisplay to create CitationMetadata array. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Message Content Component for Citation Display</name>
  <files>components/chat/message-content.tsx</files>
  <action>
Update the MessageContent component to display citation source indicators below assistant messages.

**Step 1: Add CitationMetadata type import and prop (top of file):**

```typescript
'use client';

import React from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeSanitize from 'rehype-sanitize';
import { CodeBlock } from './code-block';

// WSRV-03: Citation metadata for display
export interface CitationMetadata {
  url: string;
  domain: string;
  title?: string;
}

interface MessageContentProps {
  content: string;
  isUser?: boolean;
  citations?: CitationMetadata[]; // NEW
}
```

**Step 2: Add citation footer rendering (at end of component, before closing div):**

Find the component's main return statement. After the ReactMarkdown component (around line 33-135), but still inside the outermost div, add:

```typescript
// AI messages render with full markdown support
return (
  <div
    className="text-sm leading-relaxed break-words overflow-hidden prose prose-sm dark:prose-invert max-w-none [&_ul]:list-disc [&_ul]:pl-5 [&_ol]:list-decimal [&_ol]:pl-5 [&_li]:mb-1"
    style={{ wordBreak: 'break-word', overflowWrap: 'anywhere' }}
  >
    <ReactMarkdown
      remarkPlugins={[remarkGfm]}
      rehypePlugins={[rehypeSanitize]}
      components={{
        // ... existing component overrides ...
      }}
    >
      {content}
    </ReactMarkdown>

    {/* WSRV-03: Citation source indicators */}
    {!isUser && citations && citations.length > 0 && (
      <div className="mt-4 pt-3 border-t border-border/30">
        <div className="flex items-center gap-1 text-xs text-muted-foreground mb-2">
          <span className="font-medium">Sources:</span>
        </div>
        <div className="flex flex-wrap gap-2">
          {citations.map((citation, i) => (
            <a
              key={i}
              href={citation.url}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-muted/50 hover:bg-muted text-xs transition-colors border border-border/40"
              title={citation.title || citation.url}
            >
              <span className="font-medium text-foreground/80">{citation.domain}</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
);
```

**Key design decisions:**
- Only show for assistant messages (`!isUser`)
- Only show if citations exist (`citations && citations.length > 0`)
- Border-top separator to visually distinguish from content
- "Sources:" label for clarity
- Domain name badges with hover effect
- `target="_blank"` opens in new tab
- `rel="noopener noreferrer"` for security
- `title` attribute shows full URL on hover (or title if available from Tavily)
- Rounded pill design matches modern UI patterns
- Uses existing Tailwind theme colors (muted, border, foreground)

**What NOT to change:**
- Do NOT modify user message rendering (citations only appear on assistant messages)
- Do NOT modify markdown rendering logic
- Do NOT change existing component overrides (code blocks, links, tables)
- Do NOT remove or modify XSS protection in link renderer
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Check component structure: `grep -A 3 "citations.*CitationMetadata" components/chat/message-content.tsx` — should find prop definition. Check rendering: `grep "Sources:" components/chat/message-content.tsx` — should find citation footer.
  </verify>
  <done>
MessageContent component accepts optional citations prop, renders citation footer with domain badges below assistant messages, links open in new tabs with security attributes. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Chat UI to Handle Citation Events</name>
  <files>components/chat/telegram-chat-v2.tsx</files>
  <action>
Update the main chat component to receive and store citation metadata from SSE events.

**Find the SSE event handling logic (around line 250-350, in the handleSubmit function):**

Look for the section where we parse SSE events and handle different event types. This is where the EventSource or fetch with ReadableStream processes incoming events.

**Add citation event handling:**

In the event parsing section, add a case for `type: 'citations'`:

```typescript
// Parse SSE events
const lines = data.split('\n');
for (const line of lines) {
  if (line.startsWith('data: ')) {
    const content = line.slice(6); // Remove 'data: ' prefix

    if (content === '[DONE]') {
      // Stream complete
      break;
    }

    try {
      const parsed = JSON.parse(content);

      // Handle citation metadata event
      if (parsed.type === 'citations') {
        // Store citations with the current assistant message
        setCitations(parsed.data);
        continue;
      }

      // Handle regular content chunks
      // ... existing content handling ...
    } catch (e) {
      // Not JSON, treat as plain text content
      // ... existing fallback handling ...
    }
  }
}
```

**Add state for citations (near other useState declarations):**

```typescript
const [citations, setCitations] = useState<CitationMetadata[]>([]);
```

**Pass citations to MessageContent when rendering assistant message:**

Find where messages are mapped and rendered:

```typescript
{messages.map((msg, i) => (
  <MessageContent
    key={i}
    content={msg.content}
    isUser={msg.role === 'user'}
    citations={msg.role === 'assistant' && i === messages.length - 1 ? citations : undefined}
  />
))}
```

**Reset citations on new message:**

At the start of handleSubmit, reset citations:

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  if (!input.trim()) return;

  setCitations([]); // Reset citations for new message

  // ... existing submit logic ...
};
```

**Key implementation notes:**
- Citations only apply to the CURRENT streaming message (last in array)
- Reset citations on new user input to avoid stale data
- Parse citations event separately from content events
- Store in component state, pass to MessageContent component
- Only show on assistant messages, not user messages

**What NOT to change:**
- Do NOT modify message history persistence
- Do NOT change how messages are sent to the API
- Do NOT modify voice input, conversation switching, or other features
- Do NOT change streaming content handling
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Check citation state: `grep "useState.*CitationMetadata" components/chat/telegram-chat-v2.tsx` — should find state declaration. Check event handling: `grep "type.*citations" components/chat/telegram-chat-v2.tsx` — should find citation event parsing.
  </verify>
  <done>
Chat component handles citation SSE events, stores citation metadata in state, passes to MessageContent for the current assistant message, and resets on new user input. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no TypeScript errors
2. `app/api/chat/route.ts` sends citation metadata via SSE with type:'citations'
3. `components/chat/message-content.tsx` accepts citations prop and renders domain badges
4. `components/chat/telegram-chat-v2.tsx` handles citation events and stores in state
5. Citation footer only appears on assistant messages (not user messages)
6. Citations are clickable links with target="_blank" and security attributes
7. Domain names are extracted from URLs (no full URL display)
8. Citations only show on the current streaming message (reset on new user input)
</verification>

<success_criteria>
- Assistant messages with web search results display citation source indicators below the response
- Citations show as clickable domain name badges (e.g., "nytimes.com", "techcrunch.com")
- Clicking a citation opens the source URL in a new tab
- Citations are visually separated from message content with a border-top divider
- User messages do not show citation indicators (only assistant messages)
- Citation metadata flows from backend (SSE) to frontend (component state) to display (MessageContent)
- All TypeScript code compiles without errors
- UI matches existing design system (Tailwind theme colors, spacing, typography)
</success_criteria>

<output>
After completion, create `.planning/phases/03-web-search-validation/03-02-SUMMARY.md`
</output>
