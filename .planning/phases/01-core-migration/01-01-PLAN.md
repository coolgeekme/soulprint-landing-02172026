---
phase: 01-core-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260209_progress_tracking.sql
  - rlm-service/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Database has progress_percent and import_stage columns for real-time progress tracking"
    - "RLM service has ijson, httpx, anthropic[bedrock] dependencies installed"
    - "RLM service can stream large JSON files without loading entire file into memory"
  artifacts:
    - path: "supabase/migrations/20260209_progress_tracking.sql"
      provides: "Progress tracking schema with percent and stage columns"
      contains: "ALTER TABLE user_profiles ADD COLUMN progress_percent"
    - path: "rlm-service/requirements.txt"
      provides: "Streaming dependencies for constant-memory processing"
      contains: "ijson>=3.3.0"
  key_links:
    - from: "rlm-service/main.py"
      to: "ijson library"
      via: "import ijson"
      pattern: "import ijson"
    - from: "user_profiles table"
      to: "progress tracking columns"
      via: "migration adds columns"
      pattern: "progress_percent|import_stage"
---

<objective>
Prepare database schema and RLM service dependencies for streaming import pipeline.

Purpose: Enable real-time progress tracking and constant-memory JSON processing for any size ChatGPT export.
Output: Database migration + updated RLM dependencies ready for streaming implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-migration/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create database migration for progress tracking</name>
  <files>supabase/migrations/20260209_progress_tracking.sql</files>
  <action>
Create Supabase migration adding progress tracking columns to user_profiles table:

```sql
-- Progress tracking for RLM import pipeline
ALTER TABLE user_profiles
ADD COLUMN IF NOT EXISTS progress_percent INTEGER DEFAULT 0;

ALTER TABLE user_profiles
ADD COLUMN IF NOT EXISTS import_stage TEXT;

COMMENT ON COLUMN user_profiles.progress_percent IS 'Import progress 0-100 for UI display';
COMMENT ON COLUMN user_profiles.import_stage IS 'Current stage: "Downloading export", "Parsing conversations", "Generating soulprint", etc.';
```

These columns support the streaming import pattern where RLM updates progress at each pipeline stage (download 0-20%, parse 20-50%, quick pass 50-100%).
  </action>
  <verify>
Check migration file exists and contains both columns:
```bash
grep -E "progress_percent|import_stage" supabase/migrations/20260209_progress_tracking.sql
```
  </verify>
  <done>Migration file created with progress_percent (INTEGER) and import_stage (TEXT) columns, includes comments explaining usage</done>
</task>

<task type="auto">
  <name>Add streaming dependencies to RLM service</name>
  <files>rlm-service/requirements.txt</files>
  <action>
Add streaming JSON and Bedrock dependencies to rlm-service/requirements.txt:

```
ijson>=3.3.0
httpx>=0.26.0
anthropic[bedrock]>=0.18.0
```

Per research (01-RESEARCH.md):
- ijson 3.3.0+ for streaming JSON parsing (constant memory, handles multi-GB files)
- httpx 0.26.0+ for async streaming downloads from Supabase Storage
- anthropic[bedrock] 0.18.0+ for Haiku 4.5 quick pass from Python (cleaner API than boto3)

These replace the current pattern of loading entire JSON files with json.loads() which causes OOM on 300MB+ exports.

Do NOT remove existing dependencies (fastapi, supabase, etc.) - only add these three lines.
  </action>
  <verify>
Check that streaming dependencies are in requirements.txt:
```bash
grep -E "ijson|httpx|anthropic\[bedrock\]" rlm-service/requirements.txt
```
  </verify>
  <done>requirements.txt contains ijson>=3.3.0, httpx>=0.26.0, anthropic[bedrock]>=0.18.0, existing dependencies preserved</done>
</task>

<task type="auto">
  <name>Install RLM dependencies locally for development</name>
  <files>rlm-service/requirements.txt</files>
  <action>
Install new dependencies in RLM service virtual environment:

```bash
cd /home/drewpullen/clawd/soulprint-landing/rlm-service
pip install ijson>=3.3.0 httpx>=0.26.0 'anthropic[bedrock]>=0.18.0'
```

This makes the libraries available for local development/testing before Render deployment.

If pip install fails with dependency conflicts, log the error but don't fail the task - Render will install from requirements.txt on next deploy.
  </action>
  <verify>
Check that ijson and httpx are importable:
```bash
cd /home/drewpullen/clawd/soulprint-landing/rlm-service && python3 -c "import ijson, httpx; print('Dependencies OK')"
```
  </verify>
  <done>ijson, httpx, anthropic packages installed successfully and importable from Python</done>
</task>

</tasks>

<verification>
1. Migration file exists and adds progress_percent + import_stage columns
2. requirements.txt contains ijson, httpx, anthropic[bedrock] with correct versions
3. Python can import ijson and httpx without errors
4. Existing RLM dependencies remain intact
</verification>

<success_criteria>
- Database schema ready for progress tracking (migration exists, not yet applied)
- RLM service has streaming dependencies installed
- No existing dependencies removed or broken
- Ready for Wave 2 implementation (RLM endpoint can use ijson/httpx)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-migration/01-01-SUMMARY.md`
</output>
