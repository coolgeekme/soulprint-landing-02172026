---
phase: 05-gradual-cutover
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - rlm-service/main.py
autonomous: true

must_haves:
  truths:
    - "v1 /process-full endpoint returns Deprecation and Sunset headers"
    - "Deprecation log message printed when v1 endpoint is called"
    - "Response body includes deprecation_notice field"
    - "v2 /process-full-v2 endpoint is unchanged and still functional"
  artifacts:
    - path: "rlm-service/main.py"
      provides: "Deprecation headers on v1 endpoint"
      contains: "Deprecation"
  key_links:
    - from: "rlm-service/main.py"
      to: "soulprint-rlm/main.py"
      via: "Manual sync needed — dev copy is rlm-service/, production is soulprint-rlm/"
      pattern: "Deprecation"
---

<objective>
Add RFC 8594 deprecation headers to the v1 /process-full endpoint in the local rlm-service copy, preparing for production sync. This signals callers that v1 is deprecated and /process-full-v2 should be used instead.

Purpose: Implements CUT-03 preparation. The deprecation headers serve as documentation-in-code and enable monitoring of any remaining v1 traffic. The actual v1 removal happens manually after 7+ days at 100% v2 traffic.

Output: Modified rlm-service/main.py with deprecation headers on /process-full endpoint.

IMPORTANT: This modifies the LOCAL rlm-service/main.py (dev copy in soulprint-landing). The production soulprint-rlm repo has a different main.py with lifespan, /process-full-v2, etc. This plan does NOT touch the production repo. The deprecation changes need to be manually synced to soulprint-rlm/ when deploying (DEPLOY-03 is a human action — git push to the production repo).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gradual-cutover/05-RESEARCH.md
@rlm-service/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deprecation headers to v1 /process-full endpoint</name>
  <files>rlm-service/main.py</files>
  <action>
    Modify the /process-full endpoint in rlm-service/main.py to add deprecation signals.

    1. Add `Response` to the FastAPI imports if not already imported:
       ```python
       from fastapi import FastAPI, HTTPException, BackgroundTasks, Response
       ```

    2. Add `response: Response` parameter to the process_full function signature:
       ```python
       @app.post("/process-full")
       async def process_full(request: ProcessFullRequest, background_tasks: BackgroundTasks, response: Response):
       ```

    3. Add deprecation headers at the top of the function body (before the background_tasks.add_task call):
       ```python
       # Deprecation headers (RFC 8594)
       response.headers["Deprecation"] = "true"
       response.headers["Sunset"] = "Sat, 01 Mar 2026 00:00:00 GMT"
       response.headers["Link"] = '</process-full-v2>; rel="alternate"'

       # Log deprecation usage
       print(f"[DEPRECATED] /process-full called by user {request.user_id}")
       ```

    4. Update the return value to include deprecation notice:
       ```python
       return {
           "status": "accepted",
           "message": "Full pass processing started (DEPRECATED: use /process-full-v2)",
           "deprecation_notice": "This endpoint will be removed after v2 handles 100% traffic for 7+ days. Use /process-full-v2.",
       }
       ```

    5. Update the docstring:
       ```python
       """
       DEPRECATED: Use /process-full-v2 instead.

       Accept full pass processing job and dispatch to background task.
       Returns 202 Accepted immediately - processing happens asynchronously.
       """
       ```

    Do NOT modify /process-full-v2 or any other endpoint. Do NOT modify the background task dispatch logic.
  </action>
  <verify>
    1. `python3 -c "import ast; ast.parse(open('rlm-service/main.py').read())"` passes (valid Python syntax)
    2. grep for "Deprecation" in rlm-service/main.py shows the header
    3. grep for "DEPRECATED" in rlm-service/main.py shows the log and docstring
    4. grep for "process-full-v2" in rlm-service/main.py shows the Link header and deprecation notice
  </verify>
  <done>
    - /process-full endpoint returns Deprecation: true, Sunset, and Link headers
    - Every v1 call prints [DEPRECATED] log with user_id
    - Response body includes deprecation_notice field
    - /process-full-v2 endpoint is completely unchanged
    - Background task dispatch is unchanged (still works)
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "import ast; ast.parse(open('rlm-service/main.py').read())"` succeeds
2. `grep -c "Deprecation" rlm-service/main.py` returns >= 1
3. `grep "DEPRECATED" rlm-service/main.py` shows deprecation markers
4. `grep "process-full-v2" rlm-service/main.py` exists (unchanged endpoint)
</verification>

<success_criteria>
The v1 /process-full endpoint now carries deprecation signals in headers, logs, and response body. The v2 endpoint and all background processing logic are untouched.
</success_criteria>

<output>
After completion, create `.planning/phases/05-gradual-cutover/05-02-SUMMARY.md`
</output>
