---
phase: 05-gradual-cutover
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - .planning/phases/05-gradual-cutover/CUTOVER-RUNBOOK.md
  - .planning/phases/05-gradual-cutover/validation-queries.sql
autonomous: false

must_haves:
  truths:
    - "Runbook documents all cutover stages with explicit validation gates"
    - "SQL queries can measure v2 success rate, detect stuck imports, and compare v1 vs v2"
    - "Rollback procedure is documented with exact commands"
    - "Human verifies deployment to production and initial 10% routing works"
  artifacts:
    - path: ".planning/phases/05-gradual-cutover/CUTOVER-RUNBOOK.md"
      provides: "Step-by-step cutover and rollback procedure"
      contains: "V2_ROLLOUT_PERCENT"
    - path: ".planning/phases/05-gradual-cutover/validation-queries.sql"
      provides: "Production validation SQL queries"
      contains: "full_pass_status"
  key_links:
    - from: "CUTOVER-RUNBOOK.md"
      to: "Vercel env vars + Render deployment"
      via: "Manual human execution"
      pattern: "V2_ROLLOUT_PERCENT"
---

<objective>
Create the cutover runbook and validation SQL queries that enable the human operator to safely execute the gradual rollout (10% -> 50% -> 100% -> deprecate v1).

Purpose: CUT-02 (production validation) and DEPLOY-03 (production RLM deploy) are human-timeline activities. This plan creates all the tooling and documentation the user needs to execute them safely. The checkpoint at the end verifies the user has deployed to production and confirmed initial routing works.

Output: Runbook with stage-by-stage cutover instructions, validation SQL queries file, and human verification that production deployment succeeded.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gradual-cutover/05-RESEARCH.md
@.planning/phases/05-gradual-cutover/05-01-SUMMARY.md
@.planning/phases/05-gradual-cutover/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation SQL queries and cutover runbook</name>
  <files>.planning/phases/05-gradual-cutover/validation-queries.sql, .planning/phases/05-gradual-cutover/CUTOVER-RUNBOOK.md</files>
  <action>
    Create two files:

    **File 1: validation-queries.sql**

    Include these production validation queries (from research):

    1. Overall success rate (last 24 hours):
       - Count total imports, successful (full_pass_status='complete'), failed, and stuck (processing > 2 hours)
       - Calculate success_rate_pct

    2. Detect stuck imports:
       - Find user_profiles where full_pass_status='processing' AND full_pass_started_at < NOW() - INTERVAL '2 hours'
       - Show user_id, status, started_at, minutes_stuck

    3. Performance duration histogram:
       - Bucket by <5min, 5-10min, 10-20min, 20-30min, >30min
       - Count imports per bucket from last 24 hours

    4. Error patterns:
       - Group by full_pass_error, count occurrences
       - Last 24 hours, top 10 errors

    Each query should have a comment explaining when to run it and what to look for.

    **File 2: CUTOVER-RUNBOOK.md**

    Structure the runbook with these sections:

    1. **Prerequisites** — What must be true before starting cutover:
       - SQL migration deployed (20260207_full_pass_status.sql)
       - soulprint-rlm pushed to production (git push origin main)
       - V2_ROLLOUT_PERCENT=0 set in Vercel env vars
       - /health returns processors_available: true
       - Deprecation headers verified on /process-full

    2. **Stage 1: Deploy + Canary (10% for 24h)**
       - Push soulprint-rlm to production: `cd /home/drewpullen/clawd/soulprint-rlm && git push origin main`
       - Verify Render deployment succeeds (health check passes)
       - Set V2_ROLLOUT_PERCENT=10 in Vercel
       - Deploy Vercel: `vercel --prod` (or git push to trigger)
       - Monitor: Run validation queries after 1h, 6h, 24h
       - Gate: Success rate >= 95%, zero stuck imports, no user complaints
       - Rollback: Set V2_ROLLOUT_PERCENT=0, redeploy

    3. **Stage 2: Broader validation (50% for 48h)**
       - Set V2_ROLLOUT_PERCENT=50
       - Monitor: Run validation queries every 12h
       - Gate: Same criteria as Stage 1
       - Rollback: Set V2_ROLLOUT_PERCENT=10 or 0

    4. **Stage 3: Full cutover (100% for 7+ days)**
       - Set V2_ROLLOUT_PERCENT=100
       - Monitor: Daily validation queries
       - Gate: 7 consecutive days with zero rollbacks, zero v1 traffic
       - DO NOT deprecate v1 yet

    5. **Stage 4: Deprecation (after 7+ days at 100%)**
       - Verify zero /process-full calls for 24h (check logs)
       - Mark /process-full as deprecated in code (already done in Plan 02)
       - After 7 more days: remove /process-full endpoint
       - Rename /process-full-v2 to /process-full (optional)

    6. **Emergency Rollback**
       - Set V2_ROLLOUT_PERCENT=0 in Vercel (env var change, no code deploy)
       - Verify with `vercel logs --follow | grep "Routing import request"`
       - Check RLM health: `curl https://soulprint-landing.onrender.com/health`
       - Wait 30 minutes for in-flight v2 jobs to complete/fail

    7. **Rollback decision criteria**
       - Error rate >5% for v2: immediate rollback
       - Stuck imports >10 in 1 hour: immediate rollback
       - User complaints about slow imports: rollback within 1 hour
       - Any data corruption: immediate rollback + investigation

    Keep the runbook concise and actionable. Use numbered steps, not prose. Include exact commands.
  </action>
  <verify>
    1. CUTOVER-RUNBOOK.md exists and contains all 7 sections
    2. validation-queries.sql exists and contains at least 4 queries
    3. grep for "V2_ROLLOUT_PERCENT" in CUTOVER-RUNBOOK.md returns matches
    4. grep for "full_pass_status" in validation-queries.sql returns matches
  </verify>
  <done>
    - Runbook covers all 4 rollout stages (10% -> 50% -> 100% -> deprecate)
    - Each stage has explicit gate criteria (what must be true to proceed)
    - Emergency rollback procedure documented with exact commands
    - SQL queries ready to paste into Supabase SQL Editor
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete cutover tooling:
    1. Traffic routing logic in Next.js (Plan 01) — V2_ROLLOUT_PERCENT env var controls /process-full vs /process-full-v2
    2. Deprecation headers on v1 endpoint (Plan 02) — RFC 8594 Deprecation + Sunset headers
    3. Cutover runbook with validation SQL (this plan) — Stage-by-stage rollout procedure

    What remains is HUMAN-TIMELINE work:
    - DEPLOY-03: Push soulprint-rlm to production (`git push origin main` from /home/drewpullen/clawd/soulprint-rlm)
    - CUT-01: Set V2_ROLLOUT_PERCENT in Vercel and deploy
    - CUT-02: Monitor validation queries at each stage
    - CUT-03: Deprecate v1 after 7+ days at 100%
  </what-built>
  <how-to-verify>
    1. Review the CUTOVER-RUNBOOK.md — does it match your expectations for the rollout?
    2. Review validation-queries.sql — do the queries cover what you need to monitor?
    3. Run `npm run build` in soulprint-landing — does it build cleanly?
    4. Verify the soulprint-rlm repo is ready to push:
       ```bash
       cd /home/drewpullen/clawd/soulprint-rlm
       git status
       git log --oneline -5
       ```
    5. When ready, follow Stage 1 of the runbook to begin the cutover

    Note: The actual cutover (setting V2_ROLLOUT_PERCENT, monitoring, increasing percentage) happens over days/weeks. This checkpoint verifies the tooling is ready and the code is correct.
  </how-to-verify>
  <resume-signal>Type "approved" if tooling looks good and you're ready to begin cutover, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. CUTOVER-RUNBOOK.md exists in .planning/phases/05-gradual-cutover/
2. validation-queries.sql exists in .planning/phases/05-gradual-cutover/
3. Runbook has stages 1-4 + emergency rollback
4. SQL queries validate success rate, stuck imports, duration, error patterns
</verification>

<success_criteria>
User has all tooling needed to execute the gradual cutover safely: traffic routing code deployed, deprecation headers in place, validation queries ready, and a step-by-step runbook. The remaining work is human-timeline (days/weeks of monitoring at each rollout stage).
</success_criteria>

<output>
After completion, create `.planning/phases/05-gradual-cutover/05-03-SUMMARY.md`
</output>
