---
phase: 05-gradual-cutover
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/drewpullen/clawd/soulprint-rlm/main.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Production RLM /process-full-v2 endpoint returns 202 Accepted"
    - "Production RLM /process-full endpoint returns Deprecation and Sunset headers"
    - "Production RLM /health shows processors_available: true"
  artifacts:
    - path: "/home/drewpullen/clawd/soulprint-rlm/main.py"
      provides: "Deprecation headers on v1 /process-full endpoint"
      contains: "Deprecation"
  key_links:
    - from: "/home/drewpullen/clawd/soulprint-rlm/main.py"
      to: "Render production deployment"
      via: "git push origin main"
      pattern: "Deprecation.*true"
---

<objective>
Add RFC 8594 deprecation headers to the PRODUCTION soulprint-rlm repo's /process-full endpoint, then push all unpushed commits (16 existing + 1 new) to deploy the full v1.2 pipeline to Render.

Purpose: Closes verification gaps 1 and 2 — production RLM currently returns 404 for /process-full-v2 and has no deprecation headers on /process-full because 16 commits have never been pushed.

Output: Production RLM on Render has /process-full-v2 endpoint, deprecation headers on /process-full, and all Phase 1-4 pipeline work deployed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gradual-cutover/05-02-SUMMARY.md
@.planning/phases/05-gradual-cutover/05-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deprecation headers to production RLM /process-full endpoint</name>
  <files>/home/drewpullen/clawd/soulprint-rlm/main.py</files>
  <action>
  Edit the /process-full endpoint in /home/drewpullen/clawd/soulprint-rlm/main.py (line 2479) to add RFC 8594 deprecation headers. The production endpoint currently looks like:

  ```python
  @app.post("/process-full")
  async def process_full(request: ProcessFullRequest, background_tasks: BackgroundTasks):
      """
      Full processing pipeline: Create chunks → Embed → Generate SoulPrint.
      ...
      """
  ```

  Make these changes:

  1. Add `response: Response` parameter to the function signature (import Response from fastapi if not already imported — it should already be imported since the codebase uses it elsewhere).

  2. Update the docstring to mark as DEPRECATED:
     ```python
     """
     DEPRECATED: Use /process-full-v2 instead.

     Full processing pipeline: Create chunks → Embed → Generate SoulPrint.
     Called by Vercel after parsing ZIP. Runs in background - no timeout.
     ...
     """
     ```

  3. Add deprecation headers right after the docstring, before any other logic:
     ```python
     # Deprecation headers (RFC 8594)
     response.headers["Deprecation"] = "true"
     response.headers["Sunset"] = "Sat, 01 Mar 2026 00:00:00 GMT"
     response.headers["Link"] = '</process-full-v2>; rel="alternate"'

     # Log deprecation usage
     print(f"[DEPRECATED] /process-full called by user {request.user_id}")
     ```

  4. Add deprecation_notice to the return dict (line ~2519-2525). The existing return is:
     ```python
     return {
         "status": "processing",
         "message": "Full processing started: chunking → embedding → soulprint.",
         ...
     }
     ```
     Change to:
     ```python
     return {
         "status": "processing",
         "message": "Full processing started (DEPRECATED: use /process-full-v2)",
         "deprecation_notice": "This endpoint will be removed after v2 handles 100% traffic for 7+ days. Use /process-full-v2.",
         "user_id": request.user_id,
         "conversation_count": request.conversation_count,
         "job_id": job_id,
     }
     ```

  IMPORTANT: This is the PRODUCTION repo at /home/drewpullen/clawd/soulprint-rlm, NOT soulprint-landing/rlm-service/. The dev copy (rlm-service/main.py) already has these changes — use it as reference but edit the production file.

  After editing, commit in the soulprint-rlm repo:
  ```bash
  cd /home/drewpullen/clawd/soulprint-rlm
  git add main.py
  git commit -m "feat(05-04): add RFC 8594 deprecation headers to /process-full"
  ```
  </action>
  <verify>
  Run from the soulprint-rlm repo:
  ```bash
  cd /home/drewpullen/clawd/soulprint-rlm
  grep -n "Deprecation" main.py
  grep -n "DEPRECATED" main.py
  grep -n "deprecation_notice" main.py
  ```
  All three should return matches in the /process-full endpoint area.
  Also verify the file still parses:
  ```bash
  cd /home/drewpullen/clawd/soulprint-rlm
  python -c "import ast; ast.parse(open('main.py').read()); print('Syntax OK')"
  ```
  </verify>
  <done>Production main.py has RFC 8594 deprecation headers (Deprecation, Sunset, Link), deprecation logging, and deprecation_notice in response body on the /process-full endpoint. Committed locally.</done>
</task>

<task type="auto">
  <name>Task 2: Push all commits to deploy production RLM to Render</name>
  <files>/home/drewpullen/clawd/soulprint-rlm/.git</files>
  <action>
  Push all unpushed commits (17 total: 16 from Phases 1-4 + 1 deprecation header commit from Task 1) to the Render-connected remote:

  ```bash
  cd /home/drewpullen/clawd/soulprint-rlm
  git log --oneline origin/main..HEAD  # Show all commits being pushed
  git push origin main
  ```

  This single push deploys ALL Phase 1-5 work to production:
  - Phase 1: Supabase adapter layer
  - Phase 2: Processor modules (5 modules)
  - Phase 3: /process-full-v2 endpoint, lifespan migration, enhanced /health
  - Phase 4: Pipeline hardening, concurrency config, status tracking, integration tests
  - Phase 5: Deprecation headers on /process-full

  After push, wait 2-3 minutes for Render to build and deploy, then verify:

  ```bash
  # Health check — should show processors_available: true
  curl -s https://soulprint-landing.onrender.com/health | python3 -m json.tool

  # Verify /process-full-v2 exists (should return 422 for missing body, NOT 404)
  curl -s -X POST https://soulprint-landing.onrender.com/process-full-v2 -H "Content-Type: application/json" -d '{}' | python3 -m json.tool

  # Verify deprecation headers on /process-full
  curl -s -I -X POST https://soulprint-landing.onrender.com/process-full -H "Content-Type: application/json" -d '{"user_id":"test","storage_path":"test.json"}' 2>&1 | grep -i -E "deprecation|sunset|link"
  ```

  NOTE: Render free/starter tier may take 30-60 seconds to spin up if cold. If health check times out, wait and retry.
  NOTE: If git push fails with auth error, this becomes a checkpoint:human-action for the user to authenticate and push manually.
  </action>
  <verify>
  Three curl checks must pass:
  1. `curl -s https://soulprint-landing.onrender.com/health` returns JSON with `"processors_available": true`
  2. `curl -s -X POST https://soulprint-landing.onrender.com/process-full-v2 -H "Content-Type: application/json" -d '{}'` does NOT return `{"detail":"Not Found"}` (404 means deploy failed)
  3. `curl -s -I -X POST https://soulprint-landing.onrender.com/process-full -H "Content-Type: application/json" -d '{"user_id":"test"}' 2>&1 | grep -i deprecation` returns `Deprecation: true`
  </verify>
  <done>Production RLM on Render has /process-full-v2 endpoint (returns non-404), /health shows processors_available: true, and /process-full returns RFC 8594 deprecation headers.</done>
</task>

</tasks>

<verification>
- Production /process-full-v2 returns 202 or 422 (NOT 404)
- Production /process-full returns Deprecation: true header
- Production /health returns processors_available: true
- soulprint-rlm repo shows "Your branch is up to date with 'origin/main'"
</verification>

<success_criteria>
All 17 commits pushed to production. Render deployment succeeds. Three production endpoints verified: /health (processors available), /process-full-v2 (exists), /process-full (has deprecation headers).
</success_criteria>

<output>
After completion, create `.planning/phases/05-gradual-cutover/05-04-SUMMARY.md`
</output>
