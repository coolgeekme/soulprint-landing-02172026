---
phase: 05-gradual-cutover
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/import/process-server/route.ts
autonomous: true

must_haves:
  truths:
    - "Traffic routes to /process-full or /process-full-v2 based on V2_ROLLOUT_PERCENT env var"
    - "Routing decision is logged with endpoint name, percentage, and userId"
    - "V2_ROLLOUT_PERCENT=0 sends 100% to v1 (default, safe)"
    - "V2_ROLLOUT_PERCENT=100 sends 100% to v2"
  artifacts:
    - path: "app/api/import/process-server/route.ts"
      provides: "Traffic routing logic with V2_ROLLOUT_PERCENT"
      contains: "V2_ROLLOUT_PERCENT"
  key_links:
    - from: "app/api/import/process-server/route.ts"
      to: "RLM_API_URL + endpoint"
      via: "Math.random() percentage comparison"
      pattern: "V2_ROLLOUT_PERCENT"
---

<objective>
Add percentage-based traffic routing to the Next.js import processing route so requests are split between /process-full (v1) and /process-full-v2 (v2) based on the V2_ROLLOUT_PERCENT environment variable.

Purpose: This is the core mechanism for CUT-01 (gradual cutover). Without this, all traffic always goes to v1 regardless of env var settings. The routing happens in the Next.js caller (not the RLM service) for separation of concerns and instant rollback via env var change.

Output: Modified route.ts with traffic routing logic, ready for deployment with V2_ROLLOUT_PERCENT=0 (safe default).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gradual-cutover/05-RESEARCH.md
@app/api/import/process-server/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add V2_ROLLOUT_PERCENT traffic routing to process-server route</name>
  <files>app/api/import/process-server/route.ts</files>
  <action>
    Modify the RLM call section (lines 380-419) to add percentage-based routing.

    BEFORE the existing RLM call block (line 382, where `rlmUrl` is defined), add:

    1. Read V2_ROLLOUT_PERCENT from process.env, parse as integer, clamp to 0-100, default 0:
       ```typescript
       const v2RolloutPct = Math.max(0, Math.min(100,
         parseInt(process.env.V2_ROLLOUT_PERCENT || '0', 10) || 0
       ));
       ```
       Note: The `|| 0` after parseInt handles NaN from invalid strings.

    2. Compute routing decision:
       ```typescript
       const useV2Pipeline = Math.random() * 100 < v2RolloutPct;
       const rlmEndpoint = useV2Pipeline ? '/process-full-v2' : '/process-full';
       ```

    3. Log the routing decision with reqLog.info:
       ```typescript
       reqLog.info({
         endpoint: rlmEndpoint,
         v2RolloutPercent: v2RolloutPct,
         userId,
         conversationCount: conversations.length
       }, 'Routing import request to RLM pipeline');
       ```

    4. Change the fetch URL from:
       ```typescript
       const rlmResponse = await fetch(`${rlmUrl}/process-full`, {
       ```
       to:
       ```typescript
       const rlmResponse = await fetch(`${rlmUrl}${rlmEndpoint}`, {
       ```

    5. Update success/error logs to include the endpoint:
       - Error log: add `endpoint: rlmEndpoint` to the existing object
       - Success log: change `reqLog.info('RLM accepted job')` to `reqLog.info({ endpoint: rlmEndpoint }, 'RLM accepted job')`

    Do NOT change any other part of the file. The storage_path is already being sent (`user-imports/${parsedJsonPath}`), which is what v2 requires (WIRE-04).
  </action>
  <verify>
    1. `npm run build` passes (no TypeScript errors)
    2. grep for "V2_ROLLOUT_PERCENT" in route.ts shows the env var being read
    3. grep for "process-full-v2" in route.ts shows the v2 endpoint path
    4. grep for "Routing import request" in route.ts shows the logging
    5. The hardcoded `/process-full` string in the fetch URL is GONE (replaced by variable)
  </verify>
  <done>
    - V2_ROLLOUT_PERCENT=0 (default) routes 100% to /process-full (v1)
    - V2_ROLLOUT_PERCENT=100 routes 100% to /process-full-v2
    - V2_ROLLOUT_PERCENT=50 routes ~50% to each
    - Invalid values (NaN, negative, >100) are safely clamped
    - Every request logs the routing decision with endpoint, percentage, and userId
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `grep -c "V2_ROLLOUT_PERCENT" app/api/import/process-server/route.ts` returns >= 2 (env read + log)
3. `grep "process-full-v2" app/api/import/process-server/route.ts` shows endpoint selection
4. `grep "Routing import request" app/api/import/process-server/route.ts` shows logging
5. `grep -c "'/process-full'" app/api/import/process-server/route.ts` returns 0 (no hardcoded v1 path in fetch)
</verification>

<success_criteria>
Traffic routing logic is implemented and builds successfully. V2_ROLLOUT_PERCENT env var controls the split between /process-full and /process-full-v2. Default is 0 (all v1, safe). Routing decision is logged for every request.
</success_criteria>

<output>
After completion, create `.planning/phases/05-gradual-cutover/05-01-SUMMARY.md`
</output>
