---
phase: 05-gradual-cutover
plan: 05
type: execute
wave: 2
depends_on: ["05-04"]
files_modified: []
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "V2_ROLLOUT_PERCENT environment variable is set in Vercel production"
    - "Next.js production deployment includes traffic routing logic"
    - "Human verifies production deployment and initial routing works"
  artifacts: []
  key_links:
    - from: "Vercel V2_ROLLOUT_PERCENT env var"
      to: "app/api/import/process-server/route.ts routing logic"
      via: "process.env.V2_ROLLOUT_PERCENT read at request time"
      pattern: "V2_ROLLOUT_PERCENT"
    - from: "Next.js routing logic"
      to: "Production RLM /process-full-v2"
      via: "HTTP POST to RLM_SERVICE_URL + rlmEndpoint"
      pattern: "process-full-v2"

user_setup:
  - service: vercel
    why: "Set V2_ROLLOUT_PERCENT environment variable for traffic routing"
    env_vars:
      - name: V2_ROLLOUT_PERCENT
        source: "Vercel Dashboard -> soulprint-landing -> Settings -> Environment Variables -> Add V2_ROLLOUT_PERCENT=0 for Production"
    dashboard_config:
      - task: "Add V2_ROLLOUT_PERCENT=0 environment variable"
        location: "Vercel Dashboard -> soulprint-landing -> Settings -> Environment Variables"
---

<objective>
Set V2_ROLLOUT_PERCENT=0 in Vercel, deploy Next.js to production, and verify the full production stack is operational (RLM deployed from 05-04, Next.js routing logic, environment variable configuration).

Purpose: Closes verification gap 3 — V2_ROLLOUT_PERCENT is not configured in Vercel, preventing testing of traffic routing. This is the final gap before the human-timeline cutover runbook can begin.

Output: Production stack fully deployed and verified — ready to follow CUTOVER-RUNBOOK.md Stage 1.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gradual-cutover/05-01-SUMMARY.md
@.planning/phases/05-gradual-cutover/05-04-SUMMARY.md
@.planning/phases/05-gradual-cutover/CUTOVER-RUNBOOK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set V2_ROLLOUT_PERCENT in Vercel and deploy</name>
  <files></files>
  <action>
  Use the Vercel CLI to set V2_ROLLOUT_PERCENT=0 in production environment:

  ```bash
  # Add environment variable (production only, safe default of 0 = all traffic to v1)
  echo "0" | vercel env add V2_ROLLOUT_PERCENT production

  # Verify it was set
  vercel env ls | grep -i rollout

  # Deploy to production to pick up the new env var
  vercel --prod --yes
  ```

  V2_ROLLOUT_PERCENT=0 means 100% traffic goes to v1 (/process-full). This is the safe default — the cutover runbook will guide increasing it to 10% -> 50% -> 100% over weeks.

  NOTE: If `vercel env add` fails with auth error, this becomes a checkpoint:human-action. The user can set V2_ROLLOUT_PERCENT=0 in Vercel Dashboard -> soulprint-landing -> Settings -> Environment Variables -> Add, then run `vercel --prod` to deploy.

  NOTE: If `vercel --prod` fails, the user can also trigger deploy via `git push origin main` from the soulprint-landing repo (Vercel auto-deploys from main branch).

  After deployment completes (typically 1-2 minutes), verify:
  ```bash
  # Check deployment is live
  curl -s -o /dev/null -w "%{http_code}" https://soulprint.chat
  ```
  </action>
  <verify>
  ```bash
  vercel env ls | grep -i rollout
  ```
  Should show V2_ROLLOUT_PERCENT in the list. Production deployment should be active.
  </verify>
  <done>V2_ROLLOUT_PERCENT=0 is set in Vercel production environment. Next.js is deployed with traffic routing logic active (defaulting to 100% v1).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify production deployment and routing readiness</name>
  <what-built>
  Full production stack deployed:
  - Production RLM on Render with /process-full-v2 endpoint, deprecation headers on /process-full, all Phase 1-4 pipeline work (from Plan 05-04)
  - Next.js on Vercel with V2_ROLLOUT_PERCENT=0 traffic routing (from Plan 05-01 + this plan)
  - Cutover runbook and validation SQL queries ready (from Plan 05-03)
  </what-built>
  <how-to-verify>
  1. Verify RLM is healthy:
     ```bash
     curl -s https://soulprint-landing.onrender.com/health | python3 -m json.tool
     ```
     Expected: `"processors_available": true`

  2. Verify /process-full-v2 exists on production:
     ```bash
     curl -s -X POST https://soulprint-landing.onrender.com/process-full-v2 \
       -H "Content-Type: application/json" \
       -d '{"user_id":"test","storage_path":"test.json"}' | python3 -m json.tool
     ```
     Expected: 202 Accepted (NOT 404 Not Found)

  3. Verify deprecation headers on /process-full:
     ```bash
     curl -s -I -X POST https://soulprint-landing.onrender.com/process-full \
       -H "Content-Type: application/json" \
       -d '{"user_id":"test","storage_path":"test.json"}' 2>&1 | grep -i -E "deprecation|sunset|link"
     ```
     Expected: `Deprecation: true`, `Sunset: Sat, 01 Mar 2026 00:00:00 GMT`, `Link: </process-full-v2>; rel="alternate"`

  4. Verify Next.js routing logic is deployed:
     - Visit https://soulprint.chat and confirm the site loads
     - Check Vercel logs (if accessible) for "Routing import request" entries

  5. Confirm you are ready to begin the cutover runbook:
     - CUTOVER-RUNBOOK.md is at .planning/phases/05-gradual-cutover/CUTOVER-RUNBOOK.md
     - Stage 1: Set V2_ROLLOUT_PERCENT=10 in Vercel to route 10% traffic to v2
     - Monitor for 24 hours using validation-queries.sql
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass and you are ready for the gradual cutover, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- V2_ROLLOUT_PERCENT is set in Vercel production environment
- Next.js production deployment is active at https://soulprint.chat
- RLM /health returns processors_available: true
- RLM /process-full-v2 returns non-404 response
- RLM /process-full returns Deprecation headers
- Human confirms all verification checks pass
</verification>

<success_criteria>
Full production stack verified: RLM deployed with v2 pipeline, Next.js deployed with traffic routing, V2_ROLLOUT_PERCENT=0 configured as safe default. User confirms readiness to begin Stage 1 of CUTOVER-RUNBOOK.md (10% traffic to v2).
</success_criteria>

<output>
After completion, create `.planning/phases/05-gradual-cutover/05-05-SUMMARY.md`
</output>
