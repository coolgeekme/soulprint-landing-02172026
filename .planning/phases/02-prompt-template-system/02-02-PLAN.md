---
phase: 02-prompt-template-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - rlm-service/prompt_builder.py
  - rlm-service/main.py
  - __tests__/cross-lang/prompt-sync.test.ts
autonomous: true

must_haves:
  truths:
    - "Python PromptBuilder produces identical v1 output to TypeScript PromptBuilder for same inputs"
    - "Python PromptBuilder produces identical v2 output to TypeScript PromptBuilder for same inputs"
    - "RLM main.py uses PromptBuilder instead of inline build_rlm_system_prompt"
    - "PROMPT_VERSION env var works identically in Python (same default, same validation, same fallback)"
    - "Cross-language tests verify hash equality for both v1 and v2 prompts"
  artifacts:
    - path: "rlm-service/prompt_builder.py"
      provides: "Python PromptBuilder class mirroring TypeScript version"
      min_lines: 100
    - path: "__tests__/cross-lang/prompt-sync.test.ts"
      provides: "Cross-language prompt synchronization tests for v1 and v2"
      min_lines: 80
    - path: "rlm-service/main.py"
      provides: "RLM query endpoint using PromptBuilder"
      contains: "PromptBuilder"
  key_links:
    - from: "rlm-service/prompt_builder.py"
      to: "rlm-service/prompt_helpers.py"
      via: "import clean_section, format_section"
      pattern: "from prompt_helpers import clean_section, format_section"
    - from: "rlm-service/main.py"
      to: "rlm-service/prompt_builder.py"
      via: "import and instantiate PromptBuilder"
      pattern: "from prompt_builder import PromptBuilder"
    - from: "__tests__/cross-lang/prompt-sync.test.ts"
      to: "lib/soulprint/prompt-builder.ts"
      via: "import PromptBuilder"
      pattern: "import.*PromptBuilder.*from.*prompt-builder"
---

<objective>
Create the Python PromptBuilder class that mirrors the TypeScript version exactly, wire it into rlm-service/main.py, and create cross-language tests verifying v1 and v2 prompts produce identical output between TypeScript and Python.

Purpose: This satisfies PRMT-03 (identical cross-language output) and ensures the RLM production path and Next.js Bedrock fallback deliver the same personality experience for both v1 and v2 prompt styles.

Output: `rlm-service/prompt_builder.py`, updated `rlm-service/main.py`, `__tests__/cross-lang/prompt-sync.test.ts`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-template-system/02-RESEARCH.md
@.planning/phases/02-prompt-template-system/02-01-SUMMARY.md
@lib/soulprint/prompt-builder.ts
@rlm-service/prompt_helpers.py
@rlm-service/main.py
@__tests__/cross-lang/prompt-hash.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python PromptBuilder and wire into rlm-service</name>
  <files>rlm-service/prompt_builder.py, rlm-service/main.py</files>
  <action>
**Create `rlm-service/prompt_builder.py`:**

Mirror the TypeScript PromptBuilder class from `lib/soulprint/prompt-builder.ts` exactly. The Python version MUST produce character-identical output for the same inputs.

1. **Imports:** `os`, `json`, `datetime`, `typing (Optional, Dict, List)`, `from prompt_helpers import clean_section, format_section`

2. **`get_prompt_version()` function:**
   - Reads `os.getenv('PROMPT_VERSION', 'v1-technical')`
   - Validates against `['v1-technical', 'v2-natural-voice']`
   - Prints warning on invalid, falls back to v1-technical

3. **`PromptBuilder` class:**
   - `__init__(self, version: Optional[str] = None)` -- uses `get_prompt_version()` if None
   - `build_system_prompt(self, ai_name, sections, soulprint_text, daily_memory, memory_context, is_owner, web_search_context, web_search_citations)` -- dispatches to v1 or v2
   - `get_version(self) -> str`

4. **`_build_technical_prompt()` (v1):**
   - Port the EXACT logic from the current `build_rlm_system_prompt` in `rlm-service/main.py` (lines 195-263)
   - Must handle: imposter mode, sections parsing, clean_section/format_section for all sections, memory, daily memory, conversation context, web search
   - CRITICAL: The preamble text must match the TypeScript v1 exactly. The current rlm-service has a slightly different greeting line ("Never start with" vs "NEVER start responses with greetings like"). Use the EXACT same text as the TypeScript PromptBuilder v1 from Plan 02-01.

5. **`_build_natural_voice_prompt()` (v2):**
   - Port the EXACT logic from the TypeScript PromptBuilder v2
   - Flowing personality primer, personality traits injection, communication style, tone
   - RAG context positioning: personality -> user/agents/identity/tools/memory -> daily memory -> ## CONTEXT -> ## REMEMBER
   - Web search results
   - Imposter mode (same as v1)

**Key sync requirements:**
- Date formatting: TypeScript uses `toLocaleDateString('en-US')` and `toLocaleTimeString('en-US')`. For cross-language test purposes, the PromptBuilder must accept optional `current_date` and `current_time` string parameters (both TS and Python) so tests can inject fixed timestamps. If not provided, compute from current time. THIS IS CRITICAL -- without injectable timestamps, cross-language hash comparison will fail due to timezone/locale differences.
- The Python `_parse_section_safe` must handle both dict inputs and JSON string inputs (matching TS behavior where profile fields are JSON strings from the database)
- String escaping: Python f-strings and TypeScript template literals must produce identical whitespace

**Update `rlm-service/main.py`:**

1. Add import: `from prompt_builder import PromptBuilder`
2. Find all 3-4 call sites of `build_rlm_system_prompt(...)` in the query endpoint
3. Replace each with `PromptBuilder().build_system_prompt(...)` passing the same arguments
4. The PromptBuilder instantiation can happen once at the top of the query function
5. Remove or keep the old `build_rlm_system_prompt` function (keep it with a deprecation comment if other files might import it, otherwise remove it)
6. Ensure all parameters are passed correctly -- the RLM currently passes `conversation_context=""` in most places and appends custom context after. This pattern should continue to work.
  </action>
  <verify>
Run `python3 -c "from prompt_builder import PromptBuilder; b = PromptBuilder(); print(b.get_version())"` from `rlm-service/` directory -- should print `v1-technical`. Run `python3 -c "from prompt_builder import PromptBuilder; b = PromptBuilder('v2-natural-voice'); print(b.get_version())"` -- should print `v2-natural-voice`. Verify `rlm-service/main.py` imports PromptBuilder.
  </verify>
  <done>
Python PromptBuilder exists in rlm-service/prompt_builder.py mirroring TypeScript version. rlm-service/main.py uses PromptBuilder at all call sites. Both v1 and v2 versions produce output matching TypeScript implementation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cross-language prompt sync tests</name>
  <files>__tests__/cross-lang/prompt-sync.test.ts, lib/soulprint/prompt-builder.ts</files>
  <action>
Create `__tests__/cross-lang/prompt-sync.test.ts` that verifies TypeScript and Python PromptBuilder produce identical output.

**PREREQUISITE:** The TypeScript PromptBuilder from Plan 02-01 must support optional `currentDate` and `currentTime` string parameters in `PromptParams` (or as constructor options). If Plan 02-01 did not add these, add them now to `lib/soulprint/prompt-builder.ts`:
- Add optional `currentDate?: string` and `currentTime?: string` to `PromptParams`
- In both `buildTechnicalPrompt` and `buildNaturalVoicePrompt`, use these if provided, otherwise compute from `new Date()`
- This is the ONLY way to ensure cross-language hash comparison works (different locales/timezones produce different date strings)

**Test structure:**

1. **Helper: `callPythonPromptBuilder(version, params) -> string`**
   - Writes a temp Python script that imports PromptBuilder, constructs params, calls build_system_prompt, prints result
   - Uses `execSync` to run it (same pattern as existing prompt-hash.test.ts)
   - The Python call must pass `current_date` and `current_time` to match the fixed values in TS tests

2. **Test fixture: `testSections`**
   - Realistic section data: soul with personality_traits, communication_style, tone_preferences; identity with archetype; user with name and interests; agents with response_style and behavioral_rules; tools with capabilities
   - Use the SAME fixture for both TS and Python

3. **Test: "v1 prompts produce identical output"**
   - Fixed date = "Saturday, February 8, 2026", fixed time = "10:00 AM EST"
   - Build profile object with sections as JSON strings (matching DB format)
   - Call TS PromptBuilder with v1-technical, fixed date/time
   - Call Python PromptBuilder with v1-technical, same sections, same fixed date/time
   - Assert: `expect(tsPrompt).toBe(pyPrompt)` (character comparison)
   - Assert: SHA256 hashes match

4. **Test: "v2 prompts produce identical output"**
   - Same fixture, same fixed timestamps
   - Both builders with v2-natural-voice
   - Assert: character-identical output and matching hashes

5. **Test: "v2 has ## REMEMBER after ## CONTEXT"**
   - Build v2 prompt with memoryContext and agents with behavioral_rules
   - Assert: indexOf('## CONTEXT') < indexOf('## REMEMBER')
   - This verifies PRMT-04 (personality reinforcement after RAG)

6. **Test: "v1 and v2 produce different output"**
   - Same inputs, v1 vs v2 should NOT be identical (basic sanity check)

7. **Test: "imposter mode produces identical output"**
   - isOwner = false for both, verify identical roast prompt

**File naming convention:** Use `prompt-sync.test.ts` (not `prompt-hash.test.ts` which already tests formatSection/cleanSection helpers). This tests the full PromptBuilder.

**Test runner:** vitest (already configured). Run with `npx vitest run __tests__/cross-lang/prompt-sync.test.ts`.
  </action>
  <verify>
Run `npx vitest run __tests__/cross-lang/prompt-sync.test.ts` -- all tests pass. The v1 and v2 cross-language hash comparisons must pass (this is the core PRMT-03 verification).
  </verify>
  <done>
Cross-language tests verify that TypeScript and Python PromptBuilder produce identical v1 and v2 prompts. The ## REMEMBER block appears after ## CONTEXT in v2 (PRMT-04). All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from prompt_builder import PromptBuilder; print('OK')"` from rlm-service/ succeeds
2. `grep -c "PromptBuilder" rlm-service/main.py` returns at least 3 (import + usage sites)
3. `npx vitest run __tests__/cross-lang/prompt-sync.test.ts` -- all tests pass
4. Cross-language v1 hash matches between TypeScript and Python
5. Cross-language v2 hash matches between TypeScript and Python
6. v2 prompt has ## REMEMBER after ## CONTEXT (PRMT-04 verified)
</verification>

<success_criteria>
- Python PromptBuilder in rlm-service/prompt_builder.py mirrors TypeScript exactly
- rlm-service/main.py uses PromptBuilder at all query call sites
- Cross-language tests pass for both v1 and v2 prompt versions
- Personality reinforcement (## REMEMBER) appears after RAG context (## CONTEXT) in v2
- No cross-language drift possible -- CI catches regressions via hash comparison
</success_criteria>

<output>
After completion, create `.planning/phases/02-prompt-template-system/02-02-SUMMARY.md`
</output>
