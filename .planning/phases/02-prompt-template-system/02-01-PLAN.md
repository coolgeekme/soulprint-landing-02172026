---
phase: 02-prompt-template-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/soulprint/prompt-builder.ts
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "PROMPT_VERSION env var selects between v1-technical and v2-natural-voice"
    - "v1-technical output is identical to current buildSystemPrompt output (no behavioral change)"
    - "v2-natural-voice uses flowing personality primer instead of markdown headers for personality"
    - "Personality instructions appear AFTER memoryContext section in v2"
    - "Behavioral rules are reinforced in ## REMEMBER block after ## CONTEXT in v2"
    - "Invalid PROMPT_VERSION falls back to v1-technical with console warning"
  artifacts:
    - path: "lib/soulprint/prompt-builder.ts"
      provides: "PromptBuilder class with versioned prompt construction"
      exports: ["PromptBuilder", "PromptVersion", "getPromptVersion", "PromptParams"]
      min_lines: 120
    - path: "app/api/chat/route.ts"
      provides: "Chat route using PromptBuilder instead of inline buildSystemPrompt"
      contains: "new PromptBuilder"
  key_links:
    - from: "lib/soulprint/prompt-builder.ts"
      to: "lib/soulprint/prompt-helpers.ts"
      via: "import cleanSection, formatSection"
      pattern: "import.*cleanSection.*formatSection.*from.*prompt-helpers"
    - from: "app/api/chat/route.ts"
      to: "lib/soulprint/prompt-builder.ts"
      via: "import and instantiate PromptBuilder"
      pattern: "import.*PromptBuilder.*from.*prompt-builder"
---

<objective>
Create the TypeScript PromptBuilder class with versioned prompt construction (v1-technical and v2-natural-voice) and wire it into the chat API route, replacing the inline buildSystemPrompt function.

Purpose: This is the core of PRMT-01 (natural voice) and PRMT-02 (versioned swap). The PromptBuilder encapsulates all prompt construction logic in a testable, reusable class that both the chat route and evaluation framework can use.

Output: `lib/soulprint/prompt-builder.ts` with PromptBuilder class, updated `app/api/chat/route.ts` using PromptBuilder.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-template-system/02-RESEARCH.md
@lib/soulprint/prompt-helpers.ts
@app/api/chat/route.ts
@lib/evaluation/baseline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PromptBuilder class with v1 and v2 builders</name>
  <files>lib/soulprint/prompt-builder.ts</files>
  <action>
Create `lib/soulprint/prompt-builder.ts` with:

1. **Types:**
   - `PromptVersion = 'v1-technical' | 'v2-natural-voice'`
   - `PromptParams` interface with: `profile` (matching UserProfile shape from chat route: `soulprint_text`, `soul_md`, `identity_md`, `user_md`, `agents_md`, `tools_md`, `memory_md` all `string | null`, plus `ai_name: string | null`, `import_status: string`), `dailyMemory` (`Array<{ fact: string; category: string }> | null`), `memoryContext` (optional string), `aiName` (string, default 'SoulPrint'), `isOwner` (boolean, default true), `webSearchContext` (optional string), `webSearchCitations` (optional string array)
   - Export the `PromptBuilderProfile` interface so the chat route and Python side can reference the same shape

2. **`getPromptVersion()` function (exported):**
   - Reads `process.env.PROMPT_VERSION`, defaults to `'v1-technical'`
   - Validates against the union type, warns and falls back on invalid values
   - Logs active version at info level

3. **`PromptBuilder` class (exported):**
   - Constructor takes optional `PromptVersion`, falls back to `getPromptVersion()`
   - `buildSystemPrompt(params: PromptParams): string` -- dispatches to private v1 or v2 method
   - `getVersion(): PromptVersion` -- getter for current version (useful for logging/testing)

4. **`private buildTechnicalPrompt(params)` (v1):**
   - EXACT copy of the current `buildSystemPrompt` from `app/api/chat/route.ts` lines 553-665
   - Must produce identical output character-for-character for the same inputs
   - Includes: imposter mode check, parseSectionSafe, cleanSection/formatSection for all 7 sections, dailyMemory, memoryContext, webSearchContext/webSearchCitations
   - Import `cleanSection` and `formatSection` from `@/lib/soulprint/prompt-helpers`

5. **`private buildNaturalVoicePrompt(params)` (v2):**
   - Flowing personality primer instead of `# {aiName}` header
   - Start: `You're {aiName}.`
   - Parse soul section JSON, extract `personality_traits` (array), `communication_style` (string), `tone_preferences` (string)
   - Inject traits naturally: `You're {trait1}, {trait2}, and {trait3}.`
   - Inject communication style: `{communication_style}.`
   - Inject tone: `Your tone is {tone_preferences}.`
   - Add the standard memory instruction paragraph (same text as v1 but without `#` heading)
   - Add directness instruction paragraph
   - Add no-greetings instruction paragraph
   - Add date/time
   - Add USER section (using formatSection) -- user context comes BEFORE memory
   - Add AGENTS section (using formatSection)
   - Add IDENTITY section (using formatSection) for archetype/role info
   - Add TOOLS section (using formatSection)
   - Add MEMORY section if present (the static memory_md field)
   - Add daily memory facts if present
   - Add `## CONTEXT\n{memoryContext}` if memoryContext exists (this is RAG retrieval)
   - CRITICAL (PRMT-04): Add `## REMEMBER` block AFTER context with behavioral_rules from agents section. Parse agents_md JSON, extract `behavioral_rules` array, render as bullet list. This prevents RAG chunks from overriding personality.
   - Add web search results if present (same format as v1)
   - Imposter mode: same as v1 (returns early with the roast prompt)

**Important implementation notes:**
- Use `parseSectionSafe` as a private method (same logic as current chat route)
- The v2 builder must handle the case where sections are null/empty gracefully (fall back to soulprint_text just like v1)
- All string concatenation must use template literals for consistency with future Python port
- Do NOT use markdown `## SOUL`, `## IDENTITY` headers in v2 for personality sections -- use flowing prose. Only use `##` for functional sections: `## USER`, `## AGENTS`, `## TOOLS`, `## MEMORY`, `## CONTEXT`, `## REMEMBER`, `## DAILY MEMORY`
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the file exports PromptBuilder, PromptVersion, getPromptVersion, PromptParams, and PromptBuilderProfile.
  </verify>
  <done>
PromptBuilder class exists with v1 (exact replica of current behavior) and v2 (natural voice with personality reinforcement after RAG context). Both versions handle all edge cases (null sections, imposter mode, web search).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PromptBuilder into chat route</name>
  <files>app/api/chat/route.ts</files>
  <action>
Modify `app/api/chat/route.ts`:

1. **Add import:**
   ```typescript
   import { PromptBuilder } from '@/lib/soulprint/prompt-builder';
   ```

2. **Replace the `buildSystemPrompt` call (around line 427):**
   - Create a PromptBuilder instance: `const promptBuilder = new PromptBuilder();`
   - Replace the call:
   ```typescript
   const systemPrompt = promptBuilder.buildSystemPrompt({
     profile: userProfile || { soulprint_text: null, import_status: 'none', ai_name: null, soul_md: null, identity_md: null, user_md: null, agents_md: null, tools_md: null, memory_md: null },
     dailyMemory: learnedFacts || [],
     memoryContext,
     aiName,
     isOwner: voiceVerified,
     webSearchContext,
     webSearchCitations,
   });
   ```

3. **Delete the inline `buildSystemPrompt` function** (lines 553-665). It is now in `lib/soulprint/prompt-builder.ts`.

4. **Keep the `UserProfile` interface** in the route file (it's used for DB query typing). The PromptBuilder's `PromptBuilderProfile` interface must be compatible (same fields). Alternatively, if PromptBuilderProfile has the same shape, import it and use `as PromptBuilderProfile` in the call.

5. **Keep the `parseSectionSafe` helper IF it's used elsewhere in the route.** If it's only used by buildSystemPrompt, it can be removed (PromptBuilder has its own copy). Check for other call sites.

6. **Keep all other route logic unchanged** -- Bedrock client, rate limiting, RLM health, memory queries, learning, streaming. ONLY the prompt building changes.

**Verification approach:** After wiring, the route behavior is identical when PROMPT_VERSION is unset or 'v1-technical' (default). Setting PROMPT_VERSION='v2-natural-voice' in .env.local activates the new style.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` to confirm the route compiles in the Next.js build. Verify the inline `buildSystemPrompt` function no longer exists in the route file (grep for `function buildSystemPrompt` in the file should return 0 results).
  </verify>
  <done>
Chat route uses PromptBuilder from lib/soulprint/prompt-builder.ts. The inline buildSystemPrompt function is removed. Default behavior (PROMPT_VERSION unset) produces identical v1 prompts. Setting PROMPT_VERSION=v2-natural-voice activates natural voice prompts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `grep -c "function buildSystemPrompt" app/api/chat/route.ts` returns 0 (inline function removed)
4. `grep -c "PromptBuilder" app/api/chat/route.ts` returns at least 2 (import + usage)
5. `grep -c "v2-natural-voice" lib/soulprint/prompt-builder.ts` returns at least 3 (type, condition, method)
6. `grep -c "## REMEMBER" lib/soulprint/prompt-builder.ts` returns at least 1 (personality reinforcement in v2)
</verification>

<success_criteria>
- PromptBuilder class in lib/soulprint/prompt-builder.ts with v1 and v2 builders
- Chat route uses PromptBuilder, inline buildSystemPrompt deleted
- v1 produces character-identical output to previous inline function
- v2 uses flowing personality primer with ## REMEMBER reinforcement after ## CONTEXT
- PROMPT_VERSION env var controls version selection with safe fallback
- TypeScript builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-prompt-template-system/02-01-SUMMARY.md`
</output>
