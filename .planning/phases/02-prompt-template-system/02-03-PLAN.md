---
phase: 02-prompt-template-system
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - lib/evaluation/baseline.ts
  - scripts/run-experiment.ts
autonomous: true

must_haves:
  truths:
    - "v2-natural-voice prompt variant is available in the experiment runner"
    - "Baseline comparison can run v1 vs v2 on the same evaluation dataset"
    - "Experiment results show per-metric scores for both v1 and v2 variants"
    - "Personality adherence metrics are comparable between v1 and v2"
  artifacts:
    - path: "lib/evaluation/baseline.ts"
      provides: "Both v1 and v2 prompt variants for evaluation"
      exports: ["v1PromptVariant", "v2PromptVariant", "buildV1SystemPrompt", "buildV2SystemPrompt"]
      min_lines: 80
    - path: "scripts/run-experiment.ts"
      provides: "CLI script supporting v2-natural-voice variant"
      contains: "v2-natural-voice"
  key_links:
    - from: "lib/evaluation/baseline.ts"
      to: "lib/soulprint/prompt-builder.ts"
      via: "import PromptBuilder for v2 variant"
      pattern: "import.*PromptBuilder.*from.*prompt-builder"
    - from: "scripts/run-experiment.ts"
      to: "lib/evaluation/baseline.ts"
      via: "import v2PromptVariant"
      pattern: "v2PromptVariant|v2-natural-voice"
---

<objective>
Wire the v2-natural-voice prompt variant into the Phase 1 evaluation framework so developers can run A/B experiments comparing v1-technical vs v2-natural-voice on the same dataset and verify personality adherence is maintained within 2% of baseline.

Purpose: This satisfies the Phase 2 success criterion "Personality adherence is maintained within 2% of baseline metrics from Phase 1" by making v2 available as an experiment variant. It also connects Phase 1 (evaluation infrastructure) with Phase 2 (prompt template system).

Output: Updated `lib/evaluation/baseline.ts` with v2 variant, updated `scripts/run-experiment.ts` supporting v2.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-template-system/02-RESEARCH.md
@.planning/phases/02-prompt-template-system/02-01-SUMMARY.md
@.planning/phases/02-prompt-template-system/02-02-SUMMARY.md
@.planning/phases/01-evaluation-foundation/01-02-SUMMARY.md
@lib/evaluation/baseline.ts
@lib/evaluation/experiments.ts
@scripts/run-experiment.ts
@lib/soulprint/prompt-builder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v2 prompt variant to evaluation baseline</name>
  <files>lib/evaluation/baseline.ts</files>
  <action>
Update `lib/evaluation/baseline.ts` to add a v2-natural-voice prompt variant alongside the existing v1:

1. **Import PromptBuilder:**
   ```typescript
   import { PromptBuilder } from '@/lib/soulprint/prompt-builder';
   ```

2. **Add `buildV2SystemPrompt(item: ChatEvalItem): string` function (exported):**
   - Creates a `PromptBuilder('v2-natural-voice')` instance
   - Maps the `ChatEvalItem` fields to `PromptParams`:
     - `profile`: Construct from `item.soulprint_context` -- JSON.stringify each section (soul, identity, user, agents, tools) into the `*_md` fields, set `soulprint_text` to null, `import_status` to 'complete', `ai_name` to 'SoulPrint', `memory_md` to null
     - `dailyMemory`: null (not available in offline eval)
     - `memoryContext`: undefined (not available in offline eval)
     - `aiName`: 'SoulPrint'
     - `isOwner`: true
   - Returns the built prompt string
   - Note: This is intentionally simpler than the v1 builder because we're measuring prompt STYLE differences, not runtime features (dailyMemory, memoryContext, webSearch don't vary between v1/v2)

3. **Add `v2PromptVariant` (exported):**
   ```typescript
   export const v2PromptVariant: PromptVariant = {
     name: 'v2-natural-voice',
     buildSystemPrompt: buildV2SystemPrompt,
   };
   ```

4. **Keep existing v1 code unchanged.** The `buildV1SystemPrompt` and `v1PromptVariant` must remain exactly as they are (frozen baseline snapshot). Do NOT refactor v1 to use PromptBuilder -- the baseline must stay frozen.

5. **Optional: Update `recordBaseline` to accept a variant parameter** so it can record baselines for both v1 and v2:
   ```typescript
   export async function recordBaseline(options: {
     datasetName: string;
     nbSamples?: number;
     variant?: PromptVariant;  // defaults to v1PromptVariant
   }): Promise<BaselineResult> {
   ```
   This is a non-breaking change (existing callers don't pass variant, get v1 by default).
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify `buildV2SystemPrompt` and `v2PromptVariant` are exported: `grep -c "export.*v2" lib/evaluation/baseline.ts` should return at least 2.
  </verify>
  <done>
v2-natural-voice prompt variant exists in baseline.ts alongside frozen v1 baseline. Both variants conform to PromptVariant interface and can be used with runExperiment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add v2 variant to experiment runner CLI</name>
  <files>scripts/run-experiment.ts</files>
  <action>
Update `scripts/run-experiment.ts` to support the v2-natural-voice variant:

1. **Import v2PromptVariant:**
   ```typescript
   import { v2PromptVariant } from '@/lib/evaluation/baseline';
   ```
   (v1PromptVariant should already be imported)

2. **Add to VARIANTS map:**
   The script likely has a map/object of variant names to PromptVariant objects. Add:
   ```typescript
   'v2-natural-voice': v2PromptVariant,
   ```

3. **Update --help output** to list v2-natural-voice as an available variant.

4. **Update usage example** if present to show v2 comparison:
   ```
   # Compare v1 vs v2:
   # npx tsx scripts/run-experiment.ts --dataset soulprint-eval-2026-02-08 --variant v1-baseline
   # npx tsx scripts/run-experiment.ts --dataset soulprint-eval-2026-02-08 --variant v2-natural-voice
   ```

This is a small change -- just registering the new variant in the existing CLI framework.
  </action>
  <verify>
Run `npx tsx scripts/run-experiment.ts --help` -- should list v2-natural-voice as an available variant. Run `npx tsc --noEmit` -- no type errors.
  </verify>
  <done>
The experiment runner CLI supports v2-natural-voice as a variant. Developers can compare v1 vs v2 on the same dataset using: `npx tsx scripts/run-experiment.ts --dataset <name> --variant v2-natural-voice`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c "v2PromptVariant\|v2-natural-voice" lib/evaluation/baseline.ts` returns at least 3
3. `grep -c "v2-natural-voice" scripts/run-experiment.ts` returns at least 1
4. `npx tsx scripts/run-experiment.ts --help` lists v2-natural-voice variant
5. Both v1 and v2 variants conform to PromptVariant interface (name + buildSystemPrompt)
</verification>

<success_criteria>
- v2-natural-voice prompt variant available in evaluation framework
- Experiment runner CLI supports running v2 experiments
- v1 baseline remains frozen (not refactored to use PromptBuilder)
- Developer can run `npx tsx scripts/run-experiment.ts --variant v2-natural-voice` to evaluate v2 prompts
- Phase 2 success criterion 5 ("within 2% of baseline") is now measurable
</success_criteria>

<output>
After completion, create `.planning/phases/02-prompt-template-system/02-03-SUMMARY.md`
</output>
