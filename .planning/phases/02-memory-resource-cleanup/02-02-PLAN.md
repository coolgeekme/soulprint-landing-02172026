---
phase: 02-memory-resource-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/chat/route.ts
  - lib/rlm/health.ts
  - app/api/import/queue-processing/route.ts
  - app/api/rlm/health/route.ts
autonomous: true

must_haves:
  truths:
    - "RLM service calls in chat route timeout after 15 seconds maximum"
    - "Timeout errors are distinguished from other failures via TimeoutError name check"
    - "Circuit breaker records failures correctly on timeout"
    - "Health check route uses AbortSignal.timeout() instead of manual AbortController"
  artifacts:
    - path: "app/api/chat/route.ts"
      provides: "Chat API with 15s RLM timeout using AbortSignal.timeout()"
      contains: "AbortSignal.timeout(15000)"
    - path: "lib/rlm/health.ts"
      provides: "Circuit breaker with modernized health check using AbortSignal.timeout()"
      contains: "AbortSignal.timeout"
    - path: "app/api/rlm/health/route.ts"
      provides: "RLM health endpoint using AbortSignal.timeout()"
      contains: "AbortSignal.timeout"
  key_links:
    - from: "app/api/chat/route.ts"
      to: "lib/rlm/health.ts"
      via: "recordFailure() on TimeoutError"
      pattern: "TimeoutError.*recordFailure"
    - from: "app/api/chat/route.ts"
      to: "AbortSignal.timeout"
      via: "15s timeout on RLM fetch"
      pattern: "AbortSignal\\.timeout\\(15000\\)"
---

<objective>
Reduce RLM service timeout from 60s to 15s and modernize all RLM-related timeout handling to use AbortSignal.timeout() with proper TimeoutError differentiation.

Purpose: REL-01 requires RLM timeout reduced to 15s with fast fallback. Currently, when RLM is slow or down, users wait up to 60 seconds before the Bedrock fallback kicks in. This makes chat unusable during RLM degradation.

Output: Chat route with 15s RLM timeout, modernized health check, and proper TimeoutError handling integrated with the existing circuit breaker.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-memory-resource-cleanup/02-RESEARCH.md
@app/api/chat/route.ts
@lib/rlm/health.ts
@app/api/rlm/health/route.ts
@app/api/import/queue-processing/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce chat route RLM timeout to 15s with TimeoutError handling</name>
  <files>app/api/chat/route.ts</files>
  <action>
    In the `tryRLMService()` function (around line 125-155):

    1. Change `AbortSignal.timeout(60000)` on line 137 to `AbortSignal.timeout(15000)`

    2. Replace the generic catch block (lines 150-154) with TimeoutError-aware handling:
       ```
       } catch (error) {
         if (error instanceof Error && error.name === 'TimeoutError') {
           console.error('[Chat] RLM timed out after 15s - falling back to Bedrock');
           recordFailure();
           return null;
         }
         console.log('[Chat] RLM service unavailable:', error instanceof Error ? error.message : error);
         recordFailure();
         return null;
       }
       ```

    3. Keep all existing circuit breaker integration (`shouldAttemptRLM()`, `recordSuccess()`, `recordFailure()` calls) unchanged.

    4. Do NOT change anything else in chat/route.ts -- the Bedrock fallback, message handling, streaming response, etc. remain exactly as-is.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Grep for `AbortSignal.timeout(15000)` in chat/route.ts confirms new timeout
    - Grep for `TimeoutError` in chat/route.ts confirms error differentiation
    - No remaining `AbortSignal.timeout(60000)` in chat/route.ts
  </verify>
  <done>Chat route RLM calls timeout after 15 seconds. TimeoutError is explicitly caught and recorded as circuit breaker failure. Bedrock fallback triggers after 15s instead of 60s.</done>
</task>

<task type="auto">
  <name>Task 2: Modernize health check and queue-processing timeout patterns</name>
  <files>lib/rlm/health.ts, app/api/rlm/health/route.ts, app/api/import/queue-processing/route.ts</files>
  <action>
    **lib/rlm/health.ts** - Modernize `checkRLMHealth()` function (lines 96-123):
    1. Replace the manual `AbortController + setTimeout + clearTimeout` pattern with `AbortSignal.timeout(5000)`
    2. Add TimeoutError differentiation in catch block:
       ```
       export async function checkRLMHealth(): Promise<boolean> {
         const rlmUrl = process.env.RLM_SERVICE_URL;
         if (!rlmUrl) return false;

         try {
           const response = await fetch(`${rlmUrl}/health`, {
             method: 'GET',
             signal: AbortSignal.timeout(5000),
           });

           if (response.ok) {
             recordSuccess();
             return true;
           }

           recordFailure();
           return false;
         } catch (error) {
           if (error instanceof Error && error.name === 'TimeoutError') {
             console.log('[RLM Health] Check timed out after 5s');
           } else {
             console.log('[RLM Health] Check failed:', error instanceof Error ? error.message : error);
           }
           recordFailure();
           return false;
         }
       }
       ```
    3. Keep all other functions in health.ts unchanged (shouldAttemptRLM, recordSuccess, recordFailure, getCircuitStatus, resetCircuit).

    **app/api/rlm/health/route.ts** - Modernize the RLM health API route:
    1. Find the `AbortController + setTimeout` pattern and replace with `AbortSignal.timeout(5000)` (or whatever the existing timeout value is)
    2. Add TimeoutError handling in catch block
    3. Remove the manual `clearTimeout(timeoutId)` call

    **app/api/import/queue-processing/route.ts** - Update timeout pattern:
    1. Find the `AbortController + setTimeout` pattern (lines 103-104, 290s timeout)
    2. Replace with `AbortSignal.timeout(290000)` -- keep the same 290s value since this is the long-running import processing, not the RLM query path
    3. Add TimeoutError handling in the catch block
    4. Remove manual `clearTimeout` call

    Do NOT change: the process-server/route.ts RLM call (line 302-303) which uses a 10s timeout just to confirm job acceptance -- this is already appropriate and separate from the query timeout.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - No remaining manual `new AbortController()` + `setTimeout(() => controller.abort()` pattern in any modified file
    - Grep for `AbortSignal.timeout` in all modified files confirms modern pattern
    - Grep for `TimeoutError` in all modified files confirms error differentiation
  </verify>
  <done>All RLM-related timeout handling uses modern AbortSignal.timeout() pattern. Health check at 5s, chat at 15s, queue-processing at 290s. TimeoutError is explicitly distinguished from other errors in all catch blocks.</done>
</task>

</tasks>

<verification>
1. `npm run build` - full build succeeds with no TypeScript errors
2. `npx vitest run` - all existing tests pass (no regressions)
3. Grep confirms no `AbortSignal.timeout(60000)` remains in codebase
4. Grep confirms `AbortSignal.timeout(15000)` exists in chat/route.ts
5. All modified files use `AbortSignal.timeout()` instead of manual AbortController + setTimeout
</verification>

<success_criteria>
- Chat route RLM timeout reduced from 60s to 15s
- All RLM-related files use AbortSignal.timeout() (no manual AbortController+setTimeout)
- TimeoutError explicitly caught and handled in all catch blocks
- Circuit breaker integration preserved (recordFailure on timeout)
- Build passes, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-memory-resource-cleanup/02-02-SUMMARY.md`
</output>
