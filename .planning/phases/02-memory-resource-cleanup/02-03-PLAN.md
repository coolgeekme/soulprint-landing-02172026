---
phase: 02-memory-resource-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/api/error-handler.ts
  - lib/api/error-handler.test.ts
  - app/api/chat/messages/route.ts
  - app/api/memory/query/route.ts
  - app/api/memory/status/route.ts
  - app/api/memory/list/route.ts
  - app/api/memory/delete/route.ts
  - app/api/memory/synthesize/route.ts
  - app/api/profile/ai-name/route.ts
  - app/api/profile/ai-avatar/route.ts
  - app/api/user/reset/route.ts
  - app/api/import/complete/route.ts
  - app/api/gamification/stats/route.ts
  - app/api/gamification/achievements/route.ts
  - app/api/gamification/xp/route.ts
  - app/api/embeddings/process/route.ts
autonomous: true

must_haves:
  truths:
    - "All critical API routes catch exceptions and return structured JSON error responses"
    - "Internal error details are not exposed to users in production"
    - "TimeoutError returns 504 status code"
    - "All error responses include error field and code field"
  artifacts:
    - path: "lib/api/error-handler.ts"
      provides: "Reusable handleAPIError() function for consistent error responses"
      exports: ["handleAPIError", "APIErrorResponse"]
      contains: "TimeoutError"
    - path: "lib/api/error-handler.test.ts"
      provides: "Tests for error handler covering all error types"
      contains: "vi.stubEnv"
  key_links:
    - from: "app/api/memory/query/route.ts"
      to: "lib/api/error-handler.ts"
      via: "import handleAPIError"
      pattern: "import.*handleAPIError.*from.*error-handler"
    - from: "lib/api/error-handler.ts"
      to: "NextResponse.json"
      via: "structured error response construction"
      pattern: "NextResponse\\.json"
---

<objective>
Create a standardized error handler and apply it across all critical API routes to ensure consistent, secure error responses.

Purpose: REL-02 requires all API routes to catch exceptions and return proper error responses. Currently, error handling is inconsistent -- some routes expose internal error messages, some return bare 500s, and there is no standard pattern. This creates security risks (information disclosure) and poor developer experience.

Output: A reusable `handleAPIError()` utility and all critical API routes updated to use it consistently.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-memory-resource-cleanup/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create standardized error handler with tests</name>
  <files>lib/api/error-handler.ts, lib/api/error-handler.test.ts</files>
  <action>
    Create `lib/api/error-handler.ts` with:

    1. Export `APIErrorResponse` interface:
       ```typescript
       export interface APIErrorResponse {
         error: string;
         code: string;
         timestamp: string;
       }
       ```

    2. Export `handleAPIError(error: unknown, context: string): Response` function:
       - Log full error details with context prefix: `console.error(`[${context}]`, error)`
       - Handle `TimeoutError` (from AbortSignal.timeout): return 504 with `{ error: 'Request timed out', code: 'TIMEOUT' }`
       - Handle standard `Error`: in development (`NODE_ENV === 'development'`), include `error.message`; in production, return generic `'An error occurred'`. Code: `'INTERNAL_ERROR'`, status: 500.
       - Handle unknown error types: return `'An unexpected error occurred'`, code `'UNKNOWN_ERROR'`, status 500.
       - All responses include `timestamp` as ISO string.
       - Use `NextResponse.json<APIErrorResponse>(body, { status })` for type-safe responses.

    3. Import NextResponse from 'next/server'.

    Create `lib/api/error-handler.test.ts` with tests:
    - Test TimeoutError returns 504 with code 'TIMEOUT'
    - Test standard Error in development returns error.message
    - Test standard Error in production returns generic message (use `vi.stubEnv('NODE_ENV', 'production')`)
    - Test unknown error (string, number, null) returns 500 with 'UNKNOWN_ERROR'
    - Test all responses include timestamp field
    - Test context string appears in console.error output (spy on console.error)
  </action>
  <verify>
    - `npx vitest run lib/api/error-handler.test.ts` - all tests pass
    - File exports handleAPIError and APIErrorResponse
  </verify>
  <done>handleAPIError function tested and working for all error types. Returns structured responses with proper status codes. Does not leak internal details in production.</done>
</task>

<task type="auto">
  <name>Task 2: Apply error handler to all critical API routes</name>
  <files>app/api/chat/messages/route.ts, app/api/memory/query/route.ts, app/api/memory/status/route.ts, app/api/memory/list/route.ts, app/api/memory/delete/route.ts, app/api/memory/synthesize/route.ts, app/api/profile/ai-name/route.ts, app/api/profile/ai-avatar/route.ts, app/api/user/reset/route.ts, app/api/import/complete/route.ts, app/api/gamification/stats/route.ts, app/api/gamification/achievements/route.ts, app/api/gamification/xp/route.ts, app/api/embeddings/process/route.ts</files>
  <action>
    For each API route listed in files, apply this transformation:

    1. Add import at top: `import { handleAPIError } from '@/lib/api/error-handler';`

    2. Find every `catch` block in the file. Replace inconsistent error handling with:
       ```typescript
       } catch (error) {
         return handleAPIError(error, 'API:RouteNameHere');
       }
       ```
       Use descriptive context strings like `'API:ChatMessages'`, `'API:MemoryQuery'`, `'API:ProfileAiName'`, etc.

    3. Preserve any SPECIFIC error handling that returns non-500 status codes:
       - 401 Unauthorized checks (auth failures) -- keep as-is, these happen BEFORE the try-catch
       - 400 Bad Request validation -- keep as-is, these are explicit validation returns
       - Only replace the generic catch-all error handlers (the ones returning 500)

    4. Do NOT modify these files (owned by other plans or excluded):
       - `app/api/chat/route.ts` (already has good error handling, modified in plan 02)
       - `app/api/import/process-server/route.ts` (complex multi-step processing with specific error states)
       - `app/api/import/chunked-upload/route.ts` (owned by plan 01)
       - `app/api/import/queue-processing/route.ts` (owned by plan 02)
       - Any admin routes (low priority, internal only)
       - Health check routes (they need specific health-check error formats)

    **Priority order for modification** (most critical user-facing routes first):
    1. chat/messages, memory/query, memory/status (chat flow critical path)
    2. profile/ai-name, profile/ai-avatar, user/reset (user actions)
    3. memory/list, memory/delete, memory/synthesize (memory management)
    4. import/complete (import flow)
    5. gamification/stats, gamification/achievements, gamification/xp (engagement)
    6. embeddings/process (background processing)

    If any route already has good error handling that matches the pattern (structured JSON with status code), just add the import and leave it. Don't over-modify working code.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - `npx vitest run` - all tests pass
    - Grep for `handleAPIError` across modified routes confirms adoption
    - Grep for `err.message` or `error.message` in catch blocks of modified routes returns zero matches (no raw error exposure)
  </verify>
  <done>All critical API routes use handleAPIError for consistent error responses. No internal error messages exposed to users. All catch blocks return structured JSON with error + code fields.</done>
</task>

</tasks>

<verification>
1. `npx vitest run lib/api/error-handler.test.ts` - error handler tests pass
2. `npm run build` - full TypeScript build succeeds
3. `npx vitest run` - full test suite passes
4. Grep for `handleAPIError` in app/api/ shows adoption across routes
5. No raw `err.message` or `error.message` exposed in catch blocks of modified routes
</verification>

<success_criteria>
- lib/api/error-handler.ts exists with handleAPIError function and tests
- 14+ API routes updated to use standardized error handler
- TimeoutError returns 504, standard errors return 500
- Production mode returns generic error messages (no internal details)
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-memory-resource-cleanup/02-03-SUMMARY.md`
</output>
