---
phase: 01-dependency-extraction
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - soulprint-rlm/adapters/__init__.py
  - soulprint-rlm/adapters/supabase_adapter.py
  - soulprint-rlm/tests/__init__.py
  - soulprint-rlm/tests/conftest.py
  - soulprint-rlm/tests/test_supabase_adapter.py
  - soulprint-rlm/pytest.ini
  - soulprint-rlm/requirements.txt
autonomous: true

must_haves:
  truths:
    - "download_conversations fetches JSON from Supabase Storage given a bucket/path string"
    - "update_user_profile PATCHes user_profiles table via Supabase REST API"
    - "save_chunks_batch POSTs chunks with user_id, is_recent, default chunk_tier, and default message_count"
    - "All adapter functions raise exceptions on non-success HTTP status codes"
    - "Adapter functions use context-managed httpx.AsyncClient (no global instances)"
    - "pytest runs with 100% coverage on adapters/ module"
  artifacts:
    - path: "adapters/supabase_adapter.py"
      provides: "Three async adapter functions for Supabase operations"
      exports: ["download_conversations", "update_user_profile", "save_chunks_batch"]
    - path: "adapters/__init__.py"
      provides: "Public API for adapter module"
      contains: "from .supabase_adapter import"
    - path: "tests/test_supabase_adapter.py"
      provides: "Unit tests for all 3 adapter functions"
      min_lines: 80
    - path: "tests/conftest.py"
      provides: "Shared test fixtures (env var mocking, sample data)"
      contains: "mock_env_vars"
    - path: "pytest.ini"
      provides: "pytest configuration with asyncio_mode and coverage"
      contains: "asyncio_mode = auto"
  key_links:
    - from: "adapters/supabase_adapter.py"
      to: "httpx.AsyncClient"
      via: "async context manager per function call"
      pattern: "async with httpx\\.AsyncClient"
    - from: "tests/test_supabase_adapter.py"
      to: "adapters/supabase_adapter.py"
      via: "direct import of adapter functions"
      pattern: "from adapters\\.supabase_adapter import"
    - from: "tests/conftest.py"
      to: "SUPABASE_URL and SUPABASE_SERVICE_KEY"
      via: "monkeypatch.setenv autouse fixture"
      pattern: "monkeypatch\\.setenv.*SUPABASE"
---

<objective>
Create the Supabase adapter layer in the soulprint-rlm repo using TDD. This adapter extracts three shared Supabase operations (download_conversations, update_user_profile, save_chunks_batch) from production's inline httpx calls into a reusable module. Processors will import from this adapter instead of main.py, breaking circular dependencies.

Purpose: Satisfy MERGE-02 (adapter layer extracts shared functions) and MERGE-03 (circular import resolved) — the foundation that all later phases build on.
Output: Working adapters/ module with 100% test coverage, ready for processor imports in Phase 2.

**CRITICAL: All file operations happen in the soulprint-rlm repo at `/home/drewpullen/clawd/soulprint-rlm/`, NOT in soulprint-landing.**
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dependency-extraction/01-RESEARCH.md
</context>

<feature>
  <name>Supabase Adapter Layer</name>
  <files>
    /home/drewpullen/clawd/soulprint-rlm/adapters/__init__.py
    /home/drewpullen/clawd/soulprint-rlm/adapters/supabase_adapter.py
    /home/drewpullen/clawd/soulprint-rlm/tests/__init__.py
    /home/drewpullen/clawd/soulprint-rlm/tests/conftest.py
    /home/drewpullen/clawd/soulprint-rlm/tests/test_supabase_adapter.py
    /home/drewpullen/clawd/soulprint-rlm/pytest.ini
    /home/drewpullen/clawd/soulprint-rlm/requirements.txt
  </files>
  <behavior>
    download_conversations("user-exports/user-id/conversations.json")
      → Success: Returns list of conversation dicts (parsed from JSON response)
      → Failure (404): Raises Exception("Failed to download from storage: 404")
      → URL format: {SUPABASE_URL}/storage/v1/object/{bucket}/{path}

    update_user_profile("user-uuid", {"memory_md": "content"})
      → Success (200 or 204): Returns None (no error)
      → Failure (400): Raises Exception("Failed to update user profile: 400")
      → URL format: {SUPABASE_URL}/rest/v1/user_profiles?user_id=eq.{user_id}
      → Method: PATCH

    save_chunks_batch("user-uuid", [chunk_dicts])
      → Adds user_id to each chunk
      → Sets is_recent=True if created_at within 180 days, False otherwise
      → Defaults chunk_tier to "medium" if not provided
      → Defaults message_count to 0 if not provided
      → Success (200 or 201): Returns None
      → Failure (500): Raises Exception("Failed to save chunk batch: 500")
      → URL format: {SUPABASE_URL}/rest/v1/conversation_chunks
      → Method: POST with Prefer: return=minimal header
  </behavior>
  <implementation>
    Follow the exact code patterns from 01-RESEARCH.md. Key design decisions:
    - Use `async with httpx.AsyncClient(timeout=N) as client:` per function (no global instances)
    - Read SUPABASE_URL and SUPABASE_SERVICE_KEY from os.getenv() at module level
    - Adapters are thin wrappers — no retry logic (belongs in processors)
    - Valid chunk_tier values: "micro", "medium", "macro" — document in docstrings
    - Use @pytest.mark.anyio for async tests (not @pytest.mark.asyncio)
    - pytest-httpx for HTTP mocking (httpx_mock fixture)
    - monkeypatch autouse fixture for env vars
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Set up test infrastructure and write failing tests (RED)</name>
  <files>
    /home/drewpullen/clawd/soulprint-rlm/tests/__init__.py
    /home/drewpullen/clawd/soulprint-rlm/tests/conftest.py
    /home/drewpullen/clawd/soulprint-rlm/tests/test_supabase_adapter.py
    /home/drewpullen/clawd/soulprint-rlm/pytest.ini
    /home/drewpullen/clawd/soulprint-rlm/requirements.txt
    /home/drewpullen/clawd/soulprint-rlm/adapters/__init__.py
    /home/drewpullen/clawd/soulprint-rlm/adapters/supabase_adapter.py
  </files>
  <action>
    **Working directory: /home/drewpullen/clawd/soulprint-rlm/**

    1. Add test dependencies to requirements.txt (append, do NOT remove existing lines):
       ```
       # Test dependencies
       pytest>=8.0.0
       pytest-asyncio>=0.23.0
       pytest-cov>=4.1.0
       pytest-httpx>=0.30.0
       ```

    2. Create pytest.ini with:
       ```ini
       [pytest]
       asyncio_mode = auto
       testpaths = tests
       python_files = test_*.py
       python_classes = Test*
       python_functions = test_*
       addopts =
           --cov=adapters
           --cov-report=term-missing
           -v
       ```

    3. Create tests/__init__.py (empty file)

    4. Create tests/conftest.py with:
       - `mock_env_vars` autouse fixture using monkeypatch.setenv for SUPABASE_URL and SUPABASE_SERVICE_KEY
       - `sample_conversations` fixture returning test conversation data

    5. Create stub adapters/__init__.py and adapters/supabase_adapter.py with ONLY function signatures that raise NotImplementedError:
       ```python
       async def download_conversations(storage_path: str):
           raise NotImplementedError
       async def update_user_profile(user_id: str, updates: dict):
           raise NotImplementedError
       async def save_chunks_batch(user_id: str, chunks: list):
           raise NotImplementedError
       ```

    6. Create tests/test_supabase_adapter.py with these test cases (ALL should FAIL against stubs):

       **download_conversations tests:**
       - test_download_conversations_success: mock 200 response, verify returns parsed JSON list
       - test_download_conversations_failure_404: mock 404, verify raises Exception with status code
       - test_download_conversations_url_parsing: verify bucket/path split produces correct URL

       **update_user_profile tests:**
       - test_update_user_profile_success_204: mock 204, verify no exception
       - test_update_user_profile_success_200: mock 200, verify no exception
       - test_update_user_profile_failure_400: mock 400, verify raises Exception
       - test_update_user_profile_sends_patch: mock 204, verify PATCH method and body content

       **save_chunks_batch tests:**
       - test_save_chunks_batch_success: mock 201, verify no exception
       - test_save_chunks_batch_adds_user_id: mock 201, verify each chunk has user_id in request body
       - test_save_chunks_batch_sets_is_recent_true: chunk with created_at within 180 days → is_recent=True
       - test_save_chunks_batch_sets_is_recent_false: chunk with created_at 200+ days ago → is_recent=False
       - test_save_chunks_batch_defaults_chunk_tier: chunk without chunk_tier → defaults to "medium"
       - test_save_chunks_batch_defaults_message_count: chunk without message_count → defaults to 0
       - test_save_chunks_batch_no_created_at: chunk without created_at → is_recent=False
       - test_save_chunks_batch_failure_500: mock 500, verify raises Exception

    7. Install test dependencies: `pip install pytest pytest-asyncio pytest-cov pytest-httpx`

    8. Run tests: `cd /home/drewpullen/clawd/soulprint-rlm && pytest tests/ -v`
       ALL tests should FAIL (NotImplementedError from stubs). This confirms RED phase.

    9. Commit: `test(01-01): add failing tests for supabase adapter`
  </action>
  <verify>
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    pytest tests/ -v 2>&1 | tail -5
    # Expected: All tests FAILED (NotImplementedError)
    # Expected: 0 passed, 15 failed (approximately)
    ```
  </verify>
  <done>
    - tests/test_supabase_adapter.py exists with 15 test cases covering all 3 adapter functions
    - tests/conftest.py has mock_env_vars autouse fixture
    - pytest.ini configured with asyncio_mode=auto and coverage
    - All tests fail with NotImplementedError (RED phase confirmed)
    - requirements.txt has test dependencies appended
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement adapter functions to pass all tests (GREEN)</name>
  <files>
    /home/drewpullen/clawd/soulprint-rlm/adapters/supabase_adapter.py
    /home/drewpullen/clawd/soulprint-rlm/adapters/__init__.py
  </files>
  <action>
    **Working directory: /home/drewpullen/clawd/soulprint-rlm/**

    1. Replace adapters/supabase_adapter.py stubs with full implementation following RESEARCH.md patterns:

       **download_conversations(storage_path: str) -> List[dict]:**
       - Parse storage_path by splitting on "/" once to get bucket and file_path
       - Construct URL: {SUPABASE_URL}/storage/v1/object/{bucket}/{file_path}
       - Use `async with httpx.AsyncClient(timeout=60.0) as client:`
       - Send GET with apikey and Authorization headers
       - If status != 200, raise Exception with status code
       - Return response.json()

       **update_user_profile(user_id: str, updates: dict) -> None:**
       - Use `async with httpx.AsyncClient(timeout=30.0) as client:`
       - Send PATCH to {SUPABASE_URL}/rest/v1/user_profiles?user_id=eq.{user_id}
       - Include apikey, Authorization, Content-Type headers
       - If status not in (200, 204), raise Exception with status code

       **save_chunks_batch(user_id: str, chunks: List[dict]) -> None:**
       - For each chunk: set user_id, compute is_recent (180 days), default chunk_tier to "medium", default message_count to 0
       - Use `async with httpx.AsyncClient(timeout=60.0) as client:`
       - Send POST to {SUPABASE_URL}/rest/v1/conversation_chunks
       - Include Prefer: return=minimal header
       - If status not in (200, 201), raise Exception with status code

       **Module-level constants:**
       - SUPABASE_URL = os.getenv("SUPABASE_URL")
       - SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")

       **Important:** The monkeypatch autouse fixture in conftest.py sets these env vars BEFORE adapter imports. Since os.getenv() is called at module level, the adapter must re-read env vars inside each function OR the test must ensure the module is imported AFTER env vars are set. The simplest approach: read env vars inside each function body (not module level) to ensure testability with monkeypatch. This is the pattern recommended in the research's anti-patterns section ("Module-level environment variable access").

       **Correction:** Move SUPABASE_URL and SUPABASE_SERVICE_KEY reads INSIDE each function:
       ```python
       async def download_conversations(storage_path: str) -> List[dict]:
           supabase_url = os.getenv("SUPABASE_URL")
           supabase_key = os.getenv("SUPABASE_SERVICE_KEY")
           # ... use supabase_url and supabase_key
       ```
       This ensures monkeypatch works correctly in tests.

    2. Update adapters/__init__.py to export all three functions:
       ```python
       from .supabase_adapter import (
           download_conversations,
           update_user_profile,
           save_chunks_batch,
       )

       __all__ = [
           "download_conversations",
           "update_user_profile",
           "save_chunks_batch",
       ]
       ```

    3. Run tests: `cd /home/drewpullen/clawd/soulprint-rlm && pytest tests/ -v`
       ALL tests should PASS.

    4. Run coverage check: `cd /home/drewpullen/clawd/soulprint-rlm && pytest tests/ --cov=adapters --cov-report=term-missing --fail-under=100`
       Must show 100% coverage on adapters/ module.

    5. Verify no production code modified:
       ```bash
       cd /home/drewpullen/clawd/soulprint-rlm && git diff main.py
       # Expected: no changes to main.py
       ```

    6. Commit: `feat(01-01): implement supabase adapter functions`
  </action>
  <verify>
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    # All tests pass
    pytest tests/ -v 2>&1 | tail -5
    # Expected: 15 passed

    # 100% coverage
    pytest tests/ --cov=adapters --cov-report=term-missing --fail-under=100
    # Expected: 100% coverage, no missing lines

    # main.py unchanged
    git diff main.py | wc -l
    # Expected: 0

    # Adapter module importable
    python -c "from adapters import download_conversations, update_user_profile, save_chunks_batch; print('OK')"
    # Expected: OK
    ```
  </verify>
  <done>
    - All 15 tests pass (GREEN phase confirmed)
    - 100% test coverage on adapters/ module
    - main.py has zero modifications (zero production risk)
    - adapters/ module exports 3 functions via __init__.py
    - No circular imports — adapters import only os, httpx, typing, datetime
    - chunk_tier documented with valid values: "micro", "medium", "macro"
  </done>
</task>

</tasks>

<verification>
Run these commands in the soulprint-rlm repo:

```bash
cd /home/drewpullen/clawd/soulprint-rlm

# 1. All tests pass
pytest tests/ -v

# 2. 100% coverage
pytest tests/ --cov=adapters --cov-report=term-missing --fail-under=100

# 3. Clean imports (no circular dependencies)
python -c "from adapters import download_conversations, update_user_profile, save_chunks_batch; print('All imports clean')"

# 4. No production code modified
git diff main.py | wc -l  # Must be 0

# 5. Adapter functions are async
python -c "import inspect; from adapters.supabase_adapter import download_conversations; print(inspect.iscoroutinefunction(download_conversations))"  # Must be True
```
</verification>

<success_criteria>
- 15 unit tests pass with 100% coverage on adapters/ module
- adapters/supabase_adapter.py exports: download_conversations, update_user_profile, save_chunks_batch
- All functions are async and use context-managed httpx.AsyncClient
- main.py has zero changes (git diff confirms)
- pytest.ini configured, test dependencies in requirements.txt
- No circular imports — adapter imports only stdlib + httpx
</success_criteria>

<output>
After completion, create `.planning/phases/01-dependency-extraction/01-01-SUMMARY.md`
</output>
