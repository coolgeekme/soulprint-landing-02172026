---
phase: 03-ux-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/import/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees specific error title ('File too large', 'Wrong file format', 'Connection issue') instead of generic 'Something went wrong'"
    - "User sees actionable guidance for each error type (e.g., 'Go to ChatGPT Settings > Data Controls > Export Data')"
    - "User sees retry button only for retryable errors (connection issues, processing errors) not for format/empty errors"
    - "Error banner at top of page shows classified error title instead of hardcoded 'Something went wrong'"
    - "Mobile user with 200MB+ file sees a warning but can proceed with import (not blocked)"
  artifacts:
    - path: "app/import/page.tsx"
      provides: "classifyImportError function, classified error UI, non-blocking mobile warning"
      contains: "classifyImportError"
  key_links:
    - from: "app/import/page.tsx classifyImportError"
      to: "app/import/page.tsx error state UI"
      via: "Error state renders classified.title, classified.message, classified.action"
      pattern: "classifyImportError.*errorMessage"
    - from: "app/import/page.tsx classifyImportError"
      to: "app/import/page.tsx error banner"
      via: "Error banner renders classified title instead of hardcoded string"
      pattern: "classifyImportError"
---

<objective>
Create an error classification layer that maps raw import errors to user-friendly messages with specific titles, explanations, and actionable next steps. Replace the generic "Something went wrong" heading in both the error state and error banner. Fix mobile 200MB file size check from hard block to dismissible warning.

Purpose: Users currently see "Something went wrong" for every error type with no guidance on what to do. Mobile users with large exports are blocked entirely instead of warned. Specific, actionable error messages reduce support requests and help users self-recover.

Output: Error classification function, classified error display in both error state and error banner, non-blocking mobile file size warning.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ux-enhancement/03-RESEARCH.md
@.planning/phases/03-ux-enhancement/03-01-SUMMARY.md

@app/import/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error classification function and replace error UI</name>
  <files>app/import/page.tsx</files>
  <action>
**Part A: Add ClassifiedError interface and classifyImportError function**

Add the following ABOVE the `ImportPageContent` component (after the IMPORT_STAGES constant added by Plan 01, or after the IndexedDB helpers):

```typescript
// Error classification for actionable user-facing messages
interface ClassifiedError {
  title: string;
  message: string;
  action: string;
  canRetry: boolean;
  severity: 'warning' | 'error';
}

function classifyImportError(rawError: string): ClassifiedError {
  const lower = rawError.toLowerCase();

  // Empty export
  if (lower.includes('no conversations') || lower.includes('empty'))
    return {
      title: 'Empty export',
      message: 'No conversations were found in your file.',
      action: 'Make sure you have ChatGPT history before exporting.',
      canRetry: false,
      severity: 'error',
    };

  // Wrong file format
  if (lower.includes('conversations.json') || lower.includes('format') || lower.includes("doesn't look like") || lower.includes('not a valid'))
    return {
      title: 'Wrong file format',
      message: 'This file doesn\'t appear to be a valid ChatGPT export.',
      action: 'Go to ChatGPT Settings → Data Controls → Export Data, then upload the ZIP file you receive by email.',
      canRetry: false,
      severity: 'error',
    };

  // ZIP-specific errors
  if (lower.includes('zip'))
    return {
      title: 'Invalid ZIP file',
      message: 'The file could not be read as a ZIP archive.',
      action: 'Make sure you\'re uploading the original ZIP file from ChatGPT without unzipping it first.',
      canRetry: false,
      severity: 'error',
    };

  // File too large (entity too large)
  if (lower.includes('entity too large') || lower.includes('too large') || lower.includes('size'))
    return {
      title: 'File too large',
      message: rawError,
      action: 'Try uploading from a desktop browser, which handles large files better.',
      canRetry: true,
      severity: 'error',
    };

  // Download/storage errors (RLM couldn't fetch from Supabase)
  if (lower.includes('download') || lower.includes('storage'))
    return {
      title: 'Download failed',
      message: 'We couldn\'t retrieve your uploaded file for processing.',
      action: 'Please try uploading again.',
      canRetry: true,
      severity: 'error',
    };

  // RLM processing errors
  if (lower.includes('rlm error') || lower.includes('quick pass') || lower.includes('processing'))
    return {
      title: 'Processing error',
      message: 'Our analysis service encountered an issue.',
      action: 'This is usually temporary. Please try again in a few minutes.',
      canRetry: true,
      severity: 'error',
    };

  // Session/auth errors
  if (lower.includes('logged in') || lower.includes('unauthorized') || lower.includes('session'))
    return {
      title: 'Session expired',
      message: 'Your login session has expired.',
      action: 'Please refresh the page to log in again.',
      canRetry: false,
      severity: 'warning',
    };

  // Network/connection errors
  if (lower.includes('network') || lower.includes('fetch') || lower.includes('timeout') || lower.includes('connection'))
    return {
      title: 'Connection issue',
      message: 'The connection was interrupted during processing.',
      action: 'Check your internet connection and try again.',
      canRetry: true,
      severity: 'warning',
    };

  // Duplicate import (409 conflict - already processing)
  if (lower.includes('already processing'))
    return {
      title: 'Import already in progress',
      message: rawError,
      action: 'Wait for the current import to finish, or reset your profile to start over.',
      canRetry: false,
      severity: 'warning',
    };

  // Default fallback — pass through raw error but with friendly framing
  return {
    title: 'Something went wrong',
    message: rawError,
    action: 'Please try again. If the problem persists, contact support.',
    canRetry: true,
    severity: 'error',
  };
}
```

**Part B: Replace the ERROR STATE section**

Replace the entire `{status === 'error' && (...)}` block (currently lines 846-867 approximately, the error state with hardcoded "Something went wrong") with a classified error display:

```tsx
{status === 'error' && (
  <motion.div
    key="error"
    initial={{ opacity: 0, scale: 0.95 }}
    animate={{ opacity: 1, scale: 1 }}
    exit={{ opacity: 0, scale: 0.95 }}
    className="w-full max-w-sm flex flex-col justify-center text-center"
  >
    {(() => {
      const classified = classifyImportError(errorMessage);
      return (
        <>
          <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4 ${
            classified.severity === 'warning' ? 'bg-yellow-500/15' : 'bg-red-500/15'
          }`}>
            <AlertCircle className={`w-6 h-6 sm:w-7 sm:h-7 ${
              classified.severity === 'warning' ? 'text-yellow-500' : 'text-red-500'
            }`} />
          </div>
          <h2 className="text-lg sm:text-xl font-bold text-white mb-1 sm:mb-2">{classified.title}</h2>
          <p className="text-white/50 text-xs sm:text-sm mb-1">{classified.message}</p>
          <p className="text-white/40 text-xs mb-4 sm:mb-6">{classified.action}</p>
          {classified.canRetry ? (
            <Button
              onClick={handleRetry}
              variant="outline"
              className="border-white/20 text-white hover:bg-white/10 h-9 sm:h-10"
            >
              Try Again
            </Button>
          ) : (
            <Button
              onClick={handleRetry}
              variant="outline"
              className="border-white/20 text-white hover:bg-white/10 h-9 sm:h-10"
            >
              Start Over
            </Button>
          )}
        </>
      );
    })()}
  </motion.div>
)}
```

**Part C: Replace the error banner hardcoded title**

In the error banner (around line 656-679, the `{errorMessage && (...)}` block), replace the hardcoded title:

Find: `<p className="text-red-400 text-sm font-medium">Something went wrong</p>`

Replace with:
```tsx
<p className="text-red-400 text-sm font-medium">{classifyImportError(errorMessage).title}</p>
```

This ensures the banner also shows the classified error title (e.g., "Wrong file format" instead of "Something went wrong").
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no TypeScript errors
2. Run `npm run lint` — no linting errors
3. Read import/page.tsx and confirm:
   - `ClassifiedError` interface exists
   - `classifyImportError` function exists with categories: empty, format, zip, size, download, processing, session, network, duplicate, default
   - Error state block uses `classifyImportError(errorMessage)` to derive title, message, action
   - Error state shows `classified.title` heading (not "Something went wrong")
   - Error state shows warning severity in yellow, error severity in red
   - Error state shows different button text for retryable vs non-retryable errors
   - Error banner heading uses `classifyImportError(errorMessage).title`
  </verify>
  <done>
All error messages are classified with specific titles, explanations, and actionable next steps. Error UI shows severity-appropriate colors and retry/start-over buttons based on whether the error is retryable. Error banner shows classified title.
  </done>
</task>

<task type="auto">
  <name>Task 2: Change mobile 200MB file size check from hard block to dismissible warning</name>
  <files>app/import/page.tsx</files>
  <action>
In the `processFile` function, find the mobile file size check (around lines 298-309):

```typescript
if (isMobile && fileSizeMB > 200) {
  setErrorMessage(
    `Your export is ${fileSizeMB.toFixed(0)}MB — for the best experience with large files, ` +
    `please use a desktop/laptop browser. Mobile uploads may be slow or fail for very large exports.`
  );
  setStatus('error');
  return;
}
```

Replace with a non-blocking warning that lets the user proceed. Add a new state variable `mobileWarningDismissed` and a pending file mechanism:

1. Add a new state variable at the top of `ImportPageContent` (with the other useState calls):
```typescript
const [showMobileWarning, setShowMobileWarning] = useState(false);
const [mobileWarningFile, setMobileWarningFile] = useState<File | null>(null);
```

2. Replace the hard block code with:
```typescript
// Mobile large file warning (non-blocking)
if (isMobile && fileSizeMB > 200 && !showMobileWarning) {
  setMobileWarningFile(file);
  setShowMobileWarning(true);
  return;
}
```

3. Add a mobile warning modal in the JSX, right before the closing `</main>` tag (after the re-import modal):

```tsx
{/* Mobile Large File Warning */}
{showMobileWarning && mobileWarningFile && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm px-4">
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      className="w-full max-w-sm bg-zinc-900 border border-yellow-500/20 rounded-2xl p-6"
    >
      <div className="w-10 h-10 rounded-full bg-yellow-500/15 flex items-center justify-center mx-auto mb-3">
        <AlertCircle className="w-5 h-5 text-yellow-500" />
      </div>
      <h3 className="text-lg font-bold text-white mb-2 text-center">Large file on mobile</h3>
      <p className="text-white/60 text-sm mb-1 text-center">
        Your export is {(mobileWarningFile.size / 1024 / 1024).toFixed(0)}MB.
      </p>
      <p className="text-white/40 text-xs mb-5 text-center">
        Large uploads work best on desktop. Mobile uploads may be slow or interrupted, but you can try.
      </p>

      <div className="space-y-2.5">
        <Button
          onClick={() => {
            setShowMobileWarning(false);
            processFile(mobileWarningFile);
          }}
          className="w-full bg-orange-500 hover:bg-orange-400 text-black font-semibold h-10"
        >
          Upload anyway
        </Button>
        <button
          onClick={() => {
            setShowMobileWarning(false);
            setMobileWarningFile(null);
          }}
          className="w-full text-center text-white/40 text-xs hover:text-white/60 transition-colors py-2"
        >
          Cancel
        </button>
      </div>
    </motion.div>
  </div>
)}
```

4. When the user clicks "Upload anyway", `processFile` is called again. The guard `!showMobileWarning` prevents the warning from showing again (since `showMobileWarning` is still true when processFile re-enters — but we set it to false right before calling processFile). To avoid the warning re-triggering, adjust the guard:

Actually, the simplest approach: when the user clicks "Upload anyway", we set `showMobileWarning(false)` and then call `processFile(mobileWarningFile)`. Since `showMobileWarning` is now false, we need a different mechanism. Use a ref instead:

Replace the state approach. Instead, add a ref:
```typescript
const mobileWarningDismissedRef = useRef(false);
```

And change the guard to:
```typescript
if (isMobile && fileSizeMB > 200 && !mobileWarningDismissedRef.current) {
  setMobileWarningFile(file);
  setShowMobileWarning(true);
  return;
}
```

And the "Upload anyway" button:
```tsx
onClick={() => {
  mobileWarningDismissedRef.current = true;
  setShowMobileWarning(false);
  processFile(mobileWarningFile);
}}
```

This way, once dismissed, the ref prevents re-triggering without re-render timing issues.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no TypeScript errors
2. Run `npm run lint` — no linting errors
3. Read import/page.tsx and confirm:
   - The mobile file size check no longer calls `return` to block the import
   - `showMobileWarning` state and `mobileWarningDismissedRef` ref exist
   - Mobile warning modal exists in JSX with "Upload anyway" and "Cancel" buttons
   - "Upload anyway" sets `mobileWarningDismissedRef.current = true` and calls `processFile`
   - The guard checks `!mobileWarningDismissedRef.current` to avoid re-triggering
  </verify>
  <done>
Mobile users with 200MB+ files see a warning dialog but can proceed with "Upload anyway". The import is not blocked. The warning explains that desktop is recommended but doesn't prevent the user from trying.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run lint` passes
3. `classifyImportError` function exists and covers: empty, format, zip, size, download, processing, session, network, duplicate, default
4. Error state shows classified title (not "Something went wrong")
5. Error banner shows classified title (not "Something went wrong")
6. Error state uses severity-appropriate colors (yellow for warning, red for error)
7. Error state shows retry button only for retryable errors
8. Mobile 200MB+ file check shows warning modal, not hard block
9. Mobile user can click "Upload anyway" to proceed with import
</verification>

<success_criteria>
- Every import error displays a specific, actionable message with title, explanation, and next step
- Error severity is visually distinguished (warning in yellow, error in red)
- Mobile users with large files can proceed after seeing a warning
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-ux-enhancement/03-02-SUMMARY.md`
</output>
