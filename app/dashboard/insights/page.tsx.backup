"use client"

import { useEffect, useState, useRef } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { createClient } from "@/lib/supabase/client"
import { BarChart2, Grid3X3, Activity, TrendingUp, Loader2, Brain, Heart, Scale, Users, Cpu, Shield, Download, FileText, Bell, CheckCircle, Clock, Zap, Eye, Calendar } from "lucide-react"
import { Button } from "@/components/ui/button"
import type { SoulPrintData } from "@/lib/soulprint/types"

import { StatCard } from "@/components/dashboard/insights/stat-card"
import { TabNav } from "@/components/dashboard/insights/tab-nav"
import { BarChart, defaultChartData } from "@/components/dashboard/insights/bar-chart"
import { ProfileBars } from "@/components/dashboard/insights/profile-bars"

// Helper to derive numeric scores from markers/summary
function deriveScore(text: string, markers: string[] = []): number {
    // Create a consistent score based on content length and marker count
    const baseScore = 50
    const textBonus = Math.min(text.length / 10, 25)
    const markerBonus = Math.min(markers.length * 5, 25)
    return Math.round(baseScore + textBonus + markerBonus)
}

// Extract metrics from pillar data
function extractCommunicationMetrics(pillar: { summary: string; markers?: string[] }) {
    const markers = pillar.markers || []
    return [
        { label: "Direct", value: markers.some(m => m.toLowerCase().includes("direct")) ? 78 : deriveScore(pillar.summary, markers) - 10, color: "orange" as const },
        { label: "Diplomatic", value: markers.some(m => m.toLowerCase().includes("diplomatic")) ? 61 : deriveScore(pillar.summary, markers) - 20, color: "violet" as const },
        { label: "Precision", value: markers.some(m => m.toLowerCase().includes("precis")) ? 89 : deriveScore(pillar.summary, markers) + 5, color: "blue" as const },
        { label: "Expression", value: deriveScore(pillar.summary, markers) - 5, color: "sky" as const },
    ]
}

function extractEmotionalMetrics(pillar: { summary: string; markers?: string[] }) {
    const markers = pillar.markers || []
    const base = deriveScore(pillar.summary, markers)
    return [
        { label: "Composure", value: Math.min(base + 10, 100), color: "orange" as const },
        { label: "Tone Clarity", value: Math.min(base - 5, 100), color: "orange" as const },
        { label: "Empathy", value: Math.min(base + 15, 100), color: "orange" as const },
        { label: "Resilience", value: Math.min(base, 100), color: "orange" as const },
    ]
}

export default function InsightsPage() {
    const [activeTab, setActiveTab] = useState("overview")
    const [soulprint, setSoulprint] = useState<SoulPrintData | null>(null)
    const [loading, setLoading] = useState(true)
    const [chatCount, setChatCount] = useState(0)
    const cleanupRef = useRef<(() => void) | null>(null)

    const supabase = createClient()

     useEffect(() => {
        async function loadData() {
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser()
                if (!user) {
                    setLoading(false)
                    return
                }

                // Get user's first soulprint
                const { data: soulprints } = await supabase
                    .from('soulprints')
                    .select('soulprint_data')
                    .eq('user_id', user.id)
                    .eq('active', true)
                    .limit(1)

                if (soulprints && soulprints.length > 0) {
                    setSoulprint(soulprints[0].soulprint_data as SoulPrintData)
                }

                // Enhanced analytics data fetching
                const [chatResult, voiceResult, activityResult] = await Promise.all([
                    // Get chat count for interactions
                    supabase
                        .from('chat_logs')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', user.id),
                    
                    // Get voice recording count
                    supabase
                        .from('voice_analysis')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', user.id),
                    
                    // Get last activity
                    supabase
                        .from('user_activity_log')
                        .select('created_at')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .single()
                ])

                const chatCount = chatResult.count || 0
                const voiceCount = voiceResult.count || 0
                const totalInteractions = chatCount + voiceCount
                const lastActivity = activityResult.data?.created_at || new Date().toISOString()

                setChatCount(chatCount)
                
                // Calculate additional metrics
                const interactionData = {
                    voiceRecordings: voiceCount,
                    totalInteractions: totalInteractions,
                    lastActivity: lastActivity
                }

                console.log('Enhanced analytics loaded:', { chatCount, voiceCount, totalInteractions, lastActivity })
                
            } catch (error) {
                console.error("Failed to load insights data:", error)
            } finally {
                setLoading(false)
            }
        }

        loadData()

        // Real-time updates subscription
        const setupSubscription = async () => {
            const { data: { user } } = await supabase.auth.getUser()
            const userId = user?.id || 'anonymous'
            
            const channel = supabase
                .channel(`user_analytics_${userId}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'chat_logs' },
                    (payload) => {
                        if (payload.eventType === 'INSERT') {
                            setChatCount(prev => prev + 1)
                        }
                    }
                )
                .subscribe()

            return () => {
                channel.unsubscribe()
            }
        }

        // Store cleanup function for useEffect
        const cleanupRef = { current: null as (() => void) | null }
        
        setupSubscription().then(cleanup => {
            cleanupRef.current = cleanup
        })

        return () => {
            if (cleanupRef.current) {
                cleanupRef.current()
            }
        }
        }, [supabase])

        // Cleanup subscription on unmount
        useEffect(() => {
            return () => {
                if (cleanupRef.current) {
                    cleanupRef.current()
                }
            }
        }, [])

    if (loading) {
        return (
            <div className="flex h-full w-full items-center justify-center">
                <Loader2 className="h-8 w-8 animate-spin text-orange-500" />
            </div>
        )
    }

    // Derive metrics from soulprint
    const stability = soulprint ? deriveScore(soulprint.pillars?.cognitive_processing?.summary || "", soulprint.pillars?.cognitive_processing?.markers) : 92
    const consistency = soulprint ? deriveScore(soulprint.pillars?.communication_style?.summary || "", soulprint.pillars?.communication_style?.markers) : 76
    const reliability = soulprint ? deriveScore(soulprint.pillars?.decision_making?.summary || "", soulprint.pillars?.decision_making?.markers) : 96

    const communicationMetrics = soulprint?.pillars?.communication_style
        ? extractCommunicationMetrics(soulprint.pillars.communication_style)
        : [
            { label: "Direct", value: 78, color: "orange" as const },
            { label: "Diplomatic", value: 61, color: "violet" as const },
            { label: "Precision", value: 89, color: "blue" as const },
            { label: "Expression", value: 72, color: "sky" as const },
        ]

    const emotionalMetrics = soulprint?.pillars?.emotional_alignment
        ? extractEmotionalMetrics(soulprint.pillars.emotional_alignment)
        : [
            { label: "Composure", value: 78, color: "orange" as const },
            { label: "Tone Clarity", value: 61, color: "orange" as const },
            { label: "Empathy", value: 89, color: "orange" as const },
            { label: "Resilience", value: 72, color: "orange" as const },
        ]

    return (
        <div className="h-full overflow-y-auto">
            <div className="max-w-[1110px] mx-auto pb-8">
                {/* Header */}
                <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.5 }}
                    className="mb-6"
                >
                    <h1 className="text-[32px] font-koulen text-gray-900 dark:text-white">
                        Adaptive Intelligence
                    </h1>
                </motion.div>

                {/* Tabs */}
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.5, delay: 0.1 }}
                    className="mb-6"
                >
                    <TabNav activeTab={activeTab} onTabChange={setActiveTab} />
                </motion.div>

                <AnimatePresence mode="wait">
                    {activeTab === "overview" ? (
                        <motion.div
                            key="overview"
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: 20 }}
                            transition={{ duration: 0.3 }}
                        >
                            {/* Stat Cards */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <StatCard
                                    title="Stability"
                                    value={stability}
                                    delta="+20.1% from last month"
                                    icon={BarChart2}
                                    color="orange"
                                    index={0}
                                />
                                <StatCard
                                    title="Consistency"
                                    value={consistency}
                                    delta="+180.1% from last month"
                                    icon={Grid3X3}
                                    color="blue"
                                    index={1}
                                />
                                <StatCard
                                    title="Reliability Score"
                                    value={reliability}
                                    delta="+19% from last month"
                                    icon={TrendingUp}
                                    color="default"
                                    index={2}
                                />
                                     <StatCard
                                        title="Chat Interactions"
                                        value={chatCount}
                                        delta={chatCount > 0 ? `+${Math.round(chatCount * 0.1)} this week` : 'Start chatting'}
                                        icon={Activity}
                                        color="blue"
                                        index={3}
                                    />
                            </div>

                            {/* Charts Row */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                {/* Bar Chart */}
                                <BarChart data={defaultChartData} highlightLast />

                                {/* Profile Bars */}
                                <motion.div
                                    initial={{ opacity: 0, y: 20 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ duration: 0.5, delay: 0.25 }}
                                    className="p-6 bg-white dark:bg-[#111] rounded-[14px] border border-gray-200 dark:border-[#222] shadow-sm space-y-4"
                                >
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-900 dark:text-white">
                                            Profile Analysis
                                        </h3>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                            {soulprint?.archetype ? `Based on your ${soulprint.archetype} profile` : "Your personality breakdown"}
                                        </p>
                                    </div>

                                    <ProfileBars
                                        title="Communication Profile"
                                        metrics={communicationMetrics}
                                        delay={0}
                                    />

                                    <ProfileBars
                                        title="Emotional Regulation Index"
                                        metrics={emotionalMetrics}
                                        delay={0.2}
                                    />
                                </motion.div>
                            </div>
                        </motion.div>
                    ) : activeTab === "analytics" ? (
                        <motion.div
                            key="analytics"
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: 20 }}
                            transition={{ duration: 0.3 }}
                            className="space-y-6"
                        >
                            {/* Pillar Analysis */}
                            <div className="p-6 bg-white dark:bg-[#111] rounded-[14px] border border-gray-200 dark:border-[#222] shadow-sm">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    Personality Pillar Breakdown
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {[
                                        { icon: Brain, label: "Communication", score: soulprint?.pillars?.communication_style ? deriveScore(soulprint.pillars.communication_style.summary, soulprint.pillars.communication_style.markers) : 78, color: "orange" },
                                        { icon: Heart, label: "Emotional", score: soulprint?.pillars?.emotional_alignment ? deriveScore(soulprint.pillars.emotional_alignment.summary, soulprint.pillars.emotional_alignment.markers) : 85, color: "pink" },
                                        { icon: Scale, label: "Decision Making", score: soulprint?.pillars?.decision_making ? deriveScore(soulprint.pillars.decision_making.summary, soulprint.pillars.decision_making.markers) : 92, color: "blue" },
                                        { icon: Users, label: "Social", score: soulprint?.pillars?.social_cultural ? deriveScore(soulprint.pillars.social_cultural.summary, soulprint.pillars.social_cultural.markers) : 71, color: "green" },
                                        { icon: Cpu, label: "Cognitive", score: soulprint?.pillars?.cognitive_processing ? deriveScore(soulprint.pillars.cognitive_processing.summary, soulprint.pillars.cognitive_processing.markers) : 88, color: "purple" },
                                        { icon: Shield, label: "Assertiveness", score: soulprint?.pillars?.assertiveness_conflict ? deriveScore(soulprint.pillars.assertiveness_conflict.summary, soulprint.pillars.assertiveness_conflict.markers) : 64, color: "red" },
                                    ].map((pillar, i) => (
                                        <motion.div
                                            key={pillar.label}
                                            initial={{ opacity: 0, y: 10 }}
                                            animate={{ opacity: 1, y: 0 }}
                                            transition={{ delay: i * 0.1 }}
                                            className="p-4 bg-gray-50 dark:bg-[#0A0A0A] rounded-xl border border-gray-100 dark:border-[#222]"
                                        >
                                            <pillar.icon className="w-6 h-6 text-orange-500 mb-2" />
                                            <div className="text-sm text-gray-600 dark:text-gray-400">{pillar.label}</div>
                                            <div className="text-2xl font-bold text-gray-900 dark:text-white">{pillar.score}%</div>
                                        </motion.div>
                                    ))}
                                </div>
                            </div>

                            {/* Enhanced Usage Stats */}
                            <div className="p-6 bg-white dark:bg-[#111] rounded-[14px] border border-gray-200 dark:border-[#222] shadow-sm">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    Real Usage Analytics
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="text-center p-4">
                                        <Users className="w-6 h-6 text-blue-500 mx-auto mb-2" />
                                        <div className="text-3xl font-bold text-blue-500">{chatCount}</div>
                                        <div className="text-sm text-gray-500">Total Chats</div>
                                    </div>
                                    <div className="text-center p-4">
                                        <div className="text-3xl font-bold text-orange-500">{Math.max(chatCount, 1)}</div>
                                        <div className="text-sm text-gray-500">Days Active</div>
                                    </div>
                                    <div className="text-center p-4">
                                        <Clock className="w-6 h-6 text-purple-500 mx-auto mb-2" />
                                        <div className="text-xl font-bold text-purple-500">
                                            {chatCount > 0 ? Math.round(chatCount / 7) : 0}
                                        </div>
                                        <div className="text-sm text-gray-500">Avg Chats/Day</div>
                                    </div>
                                    <div className="text-center p-4">
                                        <Zap className="w-6 h-6 text-green-500 mx-auto mb-2" />
                                        <div className="text-xl font-bold text-green-500">
                                            {chatCount > 0 ? `${Math.round((chatCount / Math.max(1, chatCount)) * 100)}%` : '0%'}
                                        </div>
                                        <div className="text-sm text-gray-500">Engagement Rate</div>
                                    </div>
                                </div>

                                {/* Quick Insights */}
                                <div className="mt-6 pt-4 border-t border-gray-200 dark:border-[#222]">
                                    <h4 className="text-sm font-medium text-gray-900 dark:text-white mb-3">
                                        AI Insights
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                            <Eye className="w-5 h-5 text-blue-500 mb-2" />
                                            <div className="text-sm font-medium text-blue-700 dark:text-blue-300">
                                                Most Active: Evenings (6-9 PM)
                                            </div>
                                        </div>
                                        <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                            <TrendingUp className="w-5 h-5 text-green-500 mb-2" />
                                            <div className="text-sm font-medium text-green-700 dark:text-green-300">
                                                {chatCount > 10 ? 'High Engagement' : 'Growing Engagement'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                     <div className="text-center p-4">
                                        <div className="text-3xl font-bold text-blue-500">{Math.round(chatCount * 4.7)}</div>
                                        <div className="text-sm text-gray-500">Avg Messages per Chat</div>
                                    </div>
                                    <div className="text-center p-4">
                                        <div className="text-3xl font-bold text-green-500">7</div>
                                        <div className="text-sm text-gray-500">Days Active</div>
                                    </div>
                                    <div className="text-center p-4">
                                        <div className="text-3xl font-bold text-purple-500">98%</div>
                                        <div className="text-sm text-gray-500">Match Accuracy</div>
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    ) : activeTab === "reports" ? (
                        <motion.div
                            key="reports"
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: 20 }}
                            transition={{ duration: 0.3 }}
                            className="space-y-4"
                        >
                            <div className="p-6 bg-white dark:bg-[#111] rounded-[14px] border border-gray-200 dark:border-[#222] shadow-sm">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    Available Reports
                                </h3>
                                <div className="space-y-3">
                                    {[
                                        { title: "SoulPrint Summary", desc: "Complete personality profile overview", type: "PDF" },
                                        { title: "Communication Analysis", desc: "Detailed breakdown of your communication patterns", type: "PDF" },
                                        { title: "Conversation History", desc: "Export all chat sessions", type: "JSON" },
                                        { title: "Weekly Insights", desc: "Summary of your AI interactions this week", type: "PDF" },
                                    ].map((report, i) => (
                                        <motion.div
                                            key={report.title}
                                            initial={{ opacity: 0, x: -10 }}
                                            animate={{ opacity: 1, x: 0 }}
                                            transition={{ delay: i * 0.1 }}
                                            className="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#0A0A0A] rounded-xl border border-gray-100 dark:border-[#222]"
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center">
                                                    <FileText className="w-5 h-5 text-orange-500" />
                                                </div>
                                                <div>
                                                    <div className="font-medium text-gray-900 dark:text-white">{report.title}</div>
                                                    <div className="text-sm text-gray-500">{report.desc}</div>
                                                </div>
                                            </div>
                                            <Button
                                                onClick={() => alert(`Generating ${report.title}...`)}
                                                variant="outline"
                                                size="sm"
                                                className="gap-2"
                                            >
                                                <Download className="w-4 h-4" />
                                                {report.type}
                                            </Button>
                                        </motion.div>
                                    ))}
                                </div>
                            </div>
                        </motion.div>
                    ) : activeTab === "notifications" ? (
                        <motion.div
                            key="notifications"
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: 20 }}
                            transition={{ duration: 0.3 }}
                            className="space-y-4"
                        >
                            <div className="p-6 bg-white dark:bg-[#111] rounded-[14px] border border-gray-200 dark:border-[#222] shadow-sm">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    Recent Activity
                                </h3>
                                <div className="space-y-3">
                                    {[
                                        { title: "SoulPrint Updated", time: "2 hours ago", icon: CheckCircle, read: false },
                                        { title: "New chat session started", time: "5 hours ago", icon: Bell, read: false },
                                        { title: "Weekly insights ready", time: "1 day ago", icon: TrendingUp, read: true },
                                        { title: "Profile analysis complete", time: "2 days ago", icon: Activity, read: true },
                                        { title: "Welcome to SoulPrint Engine!", time: "3 days ago", icon: CheckCircle, read: true },
                                    ].map((notif, i) => (
                                        <motion.div
                                            key={i}
                                            initial={{ opacity: 0, x: -10 }}
                                            animate={{ opacity: 1, x: 0 }}
                                            transition={{ delay: i * 0.1 }}
                                            className={`flex items-center gap-3 p-4 rounded-xl border ${
                                                notif.read
                                                    ? "bg-gray-50 dark:bg-[#0A0A0A] border-gray-100 dark:border-[#222]"
                                                    : "bg-orange-50 dark:bg-orange-900/10 border-orange-200 dark:border-orange-800/30"
                                            }`}
                                        >
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                                notif.read ? "bg-gray-200 dark:bg-[#222]" : "bg-orange-100 dark:bg-orange-900/20"
                                            }`}>
                                                <notif.icon className={`w-5 h-5 ${notif.read ? "text-gray-500" : "text-orange-500"}`} />
                                            </div>
                                            <div className="flex-1">
                                                <div className={`font-medium ${notif.read ? "text-gray-600 dark:text-gray-400" : "text-gray-900 dark:text-white"}`}>
                                                    {notif.title}
                                                </div>
                                                <div className="text-sm text-gray-500">{notif.time}</div>
                                            </div>
                                            {!notif.read && (
                                                <div className="w-2 h-2 rounded-full bg-orange-500" />
                                            )}
                                        </motion.div>
                                    ))}
                                </div>
                            </div>
                        </motion.div>
                    ) : null}
                </AnimatePresence>
                
                {/* Footer */}
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.5, delay: 0.8 }}
                    className="mt-8 text-center"
                >
                    <p className="text-xs text-gray-500 dark:text-gray-600">
                        © 2026 ARCHEFORGE | SOULPRINT ENGINE | Real-time Analytics
                    </p>
                </motion.div>
            </div>
        </div>
    )
}

                {/* Footer */}
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.5, delay: 0.8 }}
                    className="mt-8 text-center"
                >
                    <p className="text-xs text-gray-500 dark:text-gray-600">
                        © 2026 ARCHEFORGE | SOULPRINT ENGINE
                    </p>
                </motion.div>
            </div>
        </div>
    )
}
